# Kubernetes 网络流量完整路径图解

> 从浏览器到 Pod 的完整流量转发过程

---

## 🌊 完整流量路径图

```
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃  第 1 层：Windows 主机（你的电脑）                                  ┃
┃                                                                    ┃
┃  ┌──────────────────────────────────────────────────────────┐    ┃
┃  │  👤 用户浏览器                                            │    ┃
┃  │  http://127.0.0.1:62218/health                           │    ┃
┃  └──────────────────┬───────────────────────────────────────┘    ┃
┃                     │                                             ┃
┃                     │ ① 发送 HTTP GET 请求                       ┃
┃                     ↓                                             ┃
┃  ┌──────────────────────────────────────────────────────────┐    ┃
┃  │  🚇 Minikube Service 隧道（自动创建）                     │    ┃
┃  │  监听：127.0.0.1:62218                                    │    ┃
┃  │  作用：桥接 Windows 网络 ↔ Minikube 虚拟网络             │    ┃
┃  └──────────────────┬───────────────────────────────────────┘    ┃
┗━━━━━━━━━━━━━━━━━━━━┃━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
                      │ ② 隧道转发
                      │ 127.0.0.1:62218 → 192.168.49.2:30080
                      ↓
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃  第 2 层：Minikube 节点（Docker Desktop 虚拟机）                  ┃
┃  节点 IP: 192.168.49.2                                           ┃
┃  节点名: minikube                                                ┃
┃                                                                   ┃
┃  ┌──────────────────────────────────────────────────────────┐   ┃
┃  │  🚪 NodePort 监听                                         │   ┃
┃  │  端口: 30080                                              │   ┃
┃  │  作用: 接收外部流量                                       │   ┃
┃  └──────────────────┬───────────────────────────────────────┘   ┃
┃                     │                                            ┃
┃                     │ ③ iptables/IPVS 规则匹配                  ┃
┃                     │    （由 kube-proxy 维护）                  ┃
┃                     ↓                                            ┃
┃  ┌──────────────────────────────────────────────────────────┐   ┃
┃  │  iptables 规则表（由 kube-proxy 自动维护）               │   ┃
┃  │                                                           │   ┃
┃  │  规则 1: NodePort 30080 → Service ClusterIP              │   ┃
┃  │          DNAT: :30080 → 10.96.123.45:8080               │   ┃
┃  │                                                           │   ┃
┃  │  规则 2: Service ClusterIP → Pod IPs (负载均衡)          │   ┃
┃  │          10.96.123.45:8080 → Random(Pod IPs)            │   ┃
┃  │          - 50% → 10.244.0.16:8080 (Pod 1)               │   ┃
┃  │          - 50% → 10.244.0.18:8080 (Pod 2)               │   ┃
┃  └──────────────────┬───────────────────────────────────────┘   ┃
┃                     │                                            ┃
┃                     │ ④ DNAT 转换                               ┃
┃                     │    30080 → 10.96.123.45:8080              ┃
┃                     ↓                                            ┃
┃  ┌──────────────────────────────────────────────────────────┐   ┃
┃  │  📡 Service（逻辑抽象，不是真实进程）                     │   ┃
┃  │  名称: api-service                                        │   ┃
┃  │  ClusterIP: 10.96.123.45                                 │   ┃
┃  │  Port: 8080                                              │   ┃
┃  │  Selector: app=api                                       │   ┃
┃  │                                                           │   ┃
┃  │  职责：                                                   │   ┃
┃  │  1. 通过 selector 找到匹配的 Pod                         │   ┃
┃  │  2. 维护 Endpoints 列表                                  │   ┃
┃  │  3. kube-proxy 根据 Service 配置生成 iptables 规则       │   ┃
┃  └──────────────────┬───────────────────────────────────────┘   ┃
┃                     │                                            ┃
┃                     │ ⑤ 查询 Endpoints                          ┃
┃                     ↓                                            ┃
┃  ┌──────────────────────────────────────────────────────────┐   ┃
┃  │  📋 Endpoints（Service 找到的 Pod 列表）                  │   ┃
┃  │  api-service: 10.244.0.16:8080, 10.244.0.18:8080        │   ┃
┃  └──────────────────┬───────────────────────────────────────┘   ┃
┃                     │                                            ┃
┃                     │ ⑥ 负载均衡选择                            ┃
┃                     │    （iptables 随机选择一个 Pod）           ┃
┃                     │    假设这次选中: 10.244.0.16:8080          ┃
┃              ┌──────┴──────┐                                     ┃
┃              │   负载均衡    │                                     ┃
┃         ┌────┴─────┬───────┴────┐                               ┃
┃         ↓          ↓            ↓                               ┃
┃    (50% 概率)  (50% 概率)   (其他 Pod)                         ┃
┃         │          │                                            ┃
┃         │          │ ⑦ 本次选中 Pod 1                           ┃
┃         ↓          │                                            ┃
┃  ┌─────────────────────────────────┐  ┌──────────────────────┐ ┃
┃  │  📦 Pod 1                        │  │  📦 Pod 2            │ ┃
┃  │  名称: api-server-26psx          │  │  名称: api-server-nlj5w│ ┃
┃  │  IP: 10.244.0.16                │  │  IP: 10.244.0.18     │ ┃
┃  │  Labels: app=api, version=v0.1  │  │  Labels: app=api     │ ┃
┃  │                                  │  │                      │ ┃
┃  │  ┌────────────────────────────┐ │  │  ┌─────────────────┐│ ┃
┃  │  │  🐳 Container (api)        │ │  │  │  🐳 Container   ││ ┃
┃  │  │  监听端口: 8080             │ │  │  │  监听端口: 8080 ││ ┃
┃  │  │                            │ │  │  │                 ││ ┃
┃  │  │  ⑧ 接收请求                │ │  │  │                 ││ ┃
┃  │  │  GET /health               │ │  │  │                 ││ ┃
┃  │  │                            │ │  │  │                 ││ ┃
┃  │  │  ⑨ Go 应用处理             │ │  │  │                 ││ ┃
┃  │  │  handler.HealthCheck()    │ │  │  │                 ││ ┃
┃  │  │  返回:                     │ │  │  │                 ││ ┃
┃  │  │  {"status":"healthy",...} │ │  │  │                 ││ ┃
┃  │  └────────────┬───────────────┘ │  │  └─────────────────┘│ ┃
┃  │               │                  │  │                      │ ┃
┃  │               │ ⑩ 响应返回       │  │                      │ ┃
┃  └───────────────┼──────────────────┘  └──────────────────────┘ ┃
┃                  │                                               ┃
┗━━━━━━━━━━━━━━━━━━┃━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
                   │ ⑪ 响应原路返回
                   │ Pod → Service → iptables → NodePort → 隧道
                   ↓
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃  第 1 层：Windows 主机（返回）                                     ┃
┃                                                                    ┃
┃  ┌──────────────────────────────────────────────────────────┐    ┃
┃  │  👤 用户浏览器                                            │    ┃
┃  │  显示: {"status":"healthy","uptime":"5m30s"}             │    ┃
┃  └──────────────────────────────────────────────────────────┘    ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
```

---

## 🎯 简化版流程图

```
请求路径（Request）：
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│  浏览器                                                          │
│  127.0.0.1:62218                                               │
│       │                                                         │
│       │ ① HTTP GET /health                                     │
│       ↓                                                         │
│  Minikube 隧道                                                  │
│  (端口映射)                                                     │
│       │                                                         │
│       │ ② 转发: 127.0.0.1:62218 → 192.168.49.2:30080         │
│       ↓                                                         │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━                    │
│  Minikube 节点 (192.168.49.2)                                  │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━                    │
│       │                                                         │
│  NodePort :30080                                               │
│       │                                                         │
│       │ ③ iptables 规则匹配                                    │
│       │    NodePort → Service ClusterIP                        │
│       ↓                                                         │
│  Service (api-service)                                         │
│  ClusterIP: 10.96.123.45:8080                                 │
│  Selector: app=api                                            │
│       │                                                         │
│       │ ④ 查找 Endpoints                                       │
│       │    10.244.0.16:8080 ✓                                 │
│       │    10.244.0.18:8080 ✓                                 │
│       │                                                         │
│       │ ⑤ 负载均衡（随机/轮询）                                │
│       │    本次选中: 10.244.0.16                               │
│       ↓                                                         │
│  ┌──────────────────┐        ┌──────────────────┐            │
│  │  Pod 1           │        │  Pod 2           │            │
│  │  10.244.0.16     │ ⬅ 选中  │  10.244.0.18     │            │
│  │  app=api         │        │  app=api         │            │
│  │                  │        │                  │            │
│  │  ⑥ Container:8080│        │  Container:8080  │            │
│  │     接收请求      │        │                  │            │
│  │                  │        │                  │            │
│  │  ⑦ Go 应用处理   │        │                  │            │
│  │     /health 接口  │        │                  │            │
│  │                  │        │                  │            │
│  │  ⑧ 返回响应      │        │                  │            │
│  │     200 OK       │        │                  │            │
│  │     JSON 数据    │        │                  │            │
│  └────────┬─────────┘        └──────────────────┘            │
│           │                                                    │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━                    │
└───────────┼────────────────────────────────────────────────────┘
            │ ⑨ 响应原路返回
            │ Pod → Service → iptables → NodePort → 隧道
            ↓
       浏览器显示
    {"status":"healthy"}
```

---

## 📍 详细步骤说明

### **步骤 ①：用户发起请求**

```
浏览器地址栏输入:
http://127.0.0.1:62218/health
        ↓
Windows 网络栈处理
        ↓
发送 HTTP GET 请求到 127.0.0.1:62218
```

**为什么是 62218 这个端口？**
- `minikube service api-service` 自动分配的随机端口
- 每次运行可能不一样（62218, 54321 等）

---

### **步骤 ②：隧道转发**

```
Minikube 隧道程序监听 127.0.0.1:62218
        ↓
接收到请求
        ↓
转换目标地址:
  从: 127.0.0.1:62218
  到: 192.168.49.2:30080
        ↓
通过虚拟网络转发到 Minikube 节点
```

**隧道的作用**：

```
Windows 网络: 192.168.1.x
      ↕ 网络隔离
Minikube 网络: 192.168.49.x

隧道 = 打通这两个网络的桥梁
```

---

### **步骤 ③：节点接收流量**

```
Minikube 节点 (192.168.49.2)
        ↓
收到对 :30080 端口的请求
        ↓
kube-proxy 配置的 iptables 规则开始工作
        ↓
查找规则: 端口 30080 对应哪个 Service？
        ↓
找到: api-service (ClusterIP 10.96.123.45:8080)
```

**iptables 规则示例**（实际规则）：

```bash
# 在 Minikube 节点上查看
sudo iptables -t nat -L -n | grep 30080

# 规则类似：
-A KUBE-NODEPORTS -p tcp -m tcp --dport 30080 \
   -j KUBE-SVC-XXXXXX

-A KUBE-SVC-XXXXXX -j DNAT \
   --to-destination 10.96.123.45:8080
```

---

### **步骤 ④：Service 处理**

```
流量到达 Service ClusterIP: 10.96.123.45:8080
        ↓
Service 本身不是进程（是虚拟 IP）
        ↓
再次匹配 iptables 规则
        ↓
根据 Selector (app=api) 查找 Endpoints
        ↓
找到 2 个 Pod：
  - 10.244.0.16:8080 (Pod 1)
  - 10.244.0.18:8080 (Pod 2)
```

**查看 Endpoints**：
```bash
kubectl get endpoints api-service

# NAME          ENDPOINTS
# api-service   10.244.0.16:8080,10.244.0.18:8080
#               ↑ 这就是 Service 找到的 Pod 列表
```

---

### **步骤 ⑤-⑥：负载均衡并转发**

```
iptables 负载均衡规则（随机算法）：
        ↓
生成随机数: 0.47
        ↓
如果 < 0.5 → 选 Pod 1 (10.244.0.16)  ← 这次
如果 ≥ 0.5 → 选 Pod 2 (10.244.0.18)
        ↓
DNAT 转换:
  目标地址: 10.244.0.16:8080
        ↓
流量转发到 Pod 1
```

**负载均衡规则示例**：

```bash
# iptables 规则
-A KUBE-SVC-XXXXXX \
   -m statistic --mode random --probability 0.5 \
   -j KUBE-SEP-AAAA  # Pod 1

-A KUBE-SVC-XXXXXX \
   -m statistic --mode random --probability 1.0 \
   -j KUBE-SEP-BBBB  # Pod 2

-A KUBE-SEP-AAAA -j DNAT \
   --to-destination 10.244.0.16:8080

-A KUBE-SEP-BBBB -j DNAT \
   --to-destination 10.244.0.18:8080
```

---

### **步骤 ⑦-⑧：Pod 内处理**

```
请求到达 Pod 1 (10.244.0.16:8080)
        ↓
Pod 内的容器收到请求
        ↓
端口 8080 在监听（你的 Go 程序）
        ↓
Gin 路由匹配: GET /health
        ↓
执行 handler.HealthCheck()
        ↓
返回 JSON:
{
  "status": "healthy",
  "uptime": "5m30s"
}
```

**实际代码**：
```go
// src/handler/health.go
func HealthCheck(c *gin.Context) {
    c.JSON(http.StatusOK, gin.H{
        "status": "healthy",
        "uptime": time.Since(startTime).String(),
    })
}
```

---

### **步骤 ⑨-⑩：响应原路返回**

```
Go 应用返回响应
        ↓
HTTP 200 OK
Body: {"status":"healthy","uptime":"5m30s"}
        ↓
通过 TCP 连接返回
        ↓
Pod (10.244.0.16:8080)
        ↓
iptables 反向转换
        ↓
Service (10.96.123.45:8080)
        ↓
NodePort (:30080)
        ↓
Minikube 隧道
        ↓
Windows 主机 (127.0.0.1:62218)
        ↓
浏览器显示
```

---

## 🔍 网络层次图

```
┌─────────────────────────────────────────────────┐
│  Layer 7 (应用层)                                │
│  HTTP GET /health                               │
└──────────────┬──────────────────────────────────┘
               ↓
┌─────────────────────────────────────────────────┐
│  Layer 4 (传输层)                                │
│  TCP 连接                                        │
│  源: Windows IP:随机端口                         │
│  目标: 不断变化（隧道 → NodePort → Service → Pod)│
└──────────────┬──────────────────────────────────┘
               ↓
┌─────────────────────────────────────────────────┐
│  Layer 3 (网络层)                                │
│  IP 包                                           │
│  DNAT 转换（多次）：                             │
│    127.0.0.1 → 192.168.49.2 → 10.96.123.45      │
│    → 10.244.0.16                                │
└──────────────┬──────────────────────────────────┘
               ↓
┌─────────────────────────────────────────────────┐
│  Layer 2 (数据链路层)                            │
│  以太网帧                                        │
└─────────────────────────────────────────────────┘
```

---

## 💡 关键组件职责

```
┌──────────────┬─────────────────────────────────────┐
│  组件         │  职责                               │
├──────────────┼─────────────────────────────────────┤
│  浏览器       │  发起 HTTP 请求                     │
├──────────────┼─────────────────────────────────────┤
│  Minikube    │  桥接 Windows 和虚拟网络             │
│  隧道        │  127.0.0.1:xxx → 节点IP:NodePort    │
├──────────────┼─────────────────────────────────────┤
│  NodePort    │  节点上的监听端口                    │
│              │  对外暴露（30000-32767）            │
├──────────────┼─────────────────────────────────────┤
│  iptables    │  执行 DNAT 转换                     │
│  规则        │  NodePort → Service → Pod           │
├──────────────┼─────────────────────────────────────┤
│  kube-proxy  │  维护 iptables 规则                 │
│              │  监听 Service 变化，自动更新规则    │
├──────────────┼─────────────────────────────────────┤
│  Service     │  逻辑抽象（配置）                   │
│              │  定义 selector、port 映射           │
├──────────────┼─────────────────────────────────────┤
│  Endpoints   │  Service 找到的 Pod IP 列表         │
│              │  自动更新                           │
├──────────────┼─────────────────────────────────────┤
│  Pod         │  运行容器                           │
│              │  有独立 IP                          │
├──────────────┼─────────────────────────────────────┤
│  Container   │  你的 Go 程序                       │
│              │  监听 8080，处理请求                │
└──────────────┴─────────────────────────────────────┘
```

---

## 🎓 对比不同访问方式

### **方式 1：minikube service（有隧道）**

```
浏览器 (127.0.0.1:62218)
    ↓ ① Windows 本地
隧道入口
    ↓ ② 隧道转发
节点 NodePort (192.168.49.2:30080)
    ↓ ③ iptables
Service (10.96.123.45:8080)
    ↓ ④ 负载均衡
Pod (10.244.0.16:8080)
    ↓ ⑤ 处理请求
响应原路返回
```

---

### **方式 2：kubectl port-forward（无 Service）**

```
浏览器 (localhost:8080)
    ↓ ① Windows 本地
kubectl port-forward 进程
    ↓ ② WebSocket 隧道
直连 Pod (10.244.0.16:8080)  ← 跳过了 Service！
    ↓ ③ 处理请求
响应返回

特点：
❌ 不经过 Service
❌ 不经过负载均衡
❌ 固定连接到一个 Pod
✅ 调试用，快速访问
```

---

### **方式 3：集群内访问（真实场景）**

```
Pod A (测试 Pod)
    ↓ ① 集群内
curl http://api-service:8080/health
    ↓ ② DNS 解析
10.96.123.45:8080 (Service ClusterIP)
    ↓ ③ iptables 负载均衡
Pod B (10.244.0.16:8080)
    ↓ ④ 处理请求
响应返回

特点：
✅ 经过 Service
✅ 经过负载均衡
✅ 真实的微服务调用场景
```

---

## 🔄 IP 地址转换过程

```
请求的目标地址变化：

浏览器发出:
  127.0.0.1:62218
        ↓ 隧道转换
  192.168.49.2:30080  (节点 IP + NodePort)
        ↓ iptables DNAT
  10.96.123.45:8080   (Service ClusterIP)
        ↓ iptables DNAT（负载均衡）
  10.244.0.16:8080    (Pod IP + targetPort)
        ↓ 最终到达
  容器内 localhost:8080
```

**每一层都做了地址转换（NAT）！**

---

## 🎯 总结

**完整流程一句话**：

```
浏览器 
  → Minikube 隧道（Windows ↔ 虚拟网络）
  → NodePort（节点端口，对外暴露）
  → iptables 规则（DNAT 转换）
  → Service（虚拟 IP，负载均衡）
  → Pod（实际容器）
  → Go 应用（处理请求）
  → 响应原路返回
```

**关键点**：
- ✅ 经过了 4 次地址转换（NAT）
- ✅ Service 通过 iptables 实现，不是真实进程
- ✅ 负载均衡在 iptables 层面实现
- ✅ 每个新连接都会重新负载均衡

---

这张图清楚了吗？🎯