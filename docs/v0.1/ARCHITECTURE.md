# v0.1 架构和流量路径详解

> 用图形化方式理解 Kubernetes 网络和节点概念

---

## 🏗️ 完整架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          你的 Windows 电脑（宿主机）                          │
│                                                                             │
│  ┌────────────────┐                                                         │
│  │   浏览器/curl   │  用户发起请求                                           │
│  │                │  http://127.0.0.1:62218/health                         │
│  └────────┬───────┘  或                                                     │
│           │          http://192.168.49.2:30080/health                       │
│           │                                                                 │
│           ↓                                                                 │
│  ┌────────────────────────────────────────────────────────────┐            │
│  │  Minikube 服务隧道（可选）                                  │            │
│  │  127.0.0.1:62218 → 192.168.49.2:30080                      │            │
│  │  作用：桥接 Windows 网络到 Minikube 虚拟网络               │            │
│  └────────────────────────────────┬───────────────────────────┘            │
│                                   │                                         │
└───────────────────────────────────┼─────────────────────────────────────────┘
                                    │
                                    │ 网络请求
                                    ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                      Docker Desktop / Minikube VM                           │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                    Kubernetes 节点（Node）                             │ │
│  │                    IP: 192.168.49.2                                    │ │
│  │                    名称: minikube                                       │ │
│  │                                                                        │ │
│  │  ┌──────────────────────────────────────────────────────────────┐    │ │
│  │  │  1️⃣  NodePort 端口监听（iptables 规则）                      │    │ │
│  │  │      端口: 30080                                              │    │ │
│  │  │      作用: 接收外部流量                                       │    │ │
│  │  └────────────────────┬─────────────────────────────────────────┘    │ │
│  │                       │                                               │ │
│  │                       ↓                                               │ │
│  │  ┌──────────────────────────────────────────────────────────────┐    │ │
│  │  │  2️⃣  kube-proxy（网络代理）                                  │    │ │
│  │  │      识别流量目标: api-service                                │    │ │
│  │  │      查找 iptables/IPVS 规则                                 │    │ │
│  │  └────────────────────┬─────────────────────────────────────────┘    │ │
│  │                       │                                               │ │
│  │                       ↓                                               │ │
│  │  ┌──────────────────────────────────────────────────────────────┐    │ │
│  │  │  3️⃣  Service（api-service）                                  │    │ │
│  │  │      ClusterIP: 10.96.123.45                                 │    │ │
│  │  │      Port: 8080                                              │    │ │
│  │  │      Selector: app=api                                       │    │ │
│  │  │                                                               │    │ │
│  │  │      功能:                                                    │    │ │
│  │  │      1. 根据 selector 找到匹配的 Pod                         │    │ │
│  │  │      2. 负载均衡（轮询/随机）                                │    │ │
│  │  │      3. 转发到 TargetPort: 8080                              │    │ │
│  │  └────────────────────┬─────────────────────────────────────────┘    │ │
│  │                       │                                               │ │
│  │                       ↓                                               │ │
│  │              ┌────────┴─────────┐                                     │ │
│  │              │  负载均衡选择     │                                     │ │
│  │              └────────┬─────────┘                                     │ │
│  │                       │                                               │ │
│  │         ┌─────────────┼─────────────┐                                │ │
│  │         ↓                           ↓                                │ │
│  │  ┌──────────────────┐        ┌──────────────────┐                   │ │
│  │  │  4️⃣  Pod 1       │        │  4️⃣  Pod 2       │                   │ │
│  │  │  api-server-xxx  │        │  api-server-yyy  │                   │ │
│  │  │  IP: 10.244.0.5  │        │  IP: 10.244.0.6  │                   │ │
│  │  │  Labels:         │        │  Labels:         │                   │ │
│  │  │    app=api       │        │    app=api       │                   │ │
│  │  │    version=v0.1  │        │    version=v0.1  │                   │ │
│  │  │                  │        │                  │                   │ │
│  │  │  ┌────────────┐  │        │  ┌────────────┐  │                   │ │
│  │  │  │ Container  │  │        │  │ Container  │  │                   │ │
│  │  │  │            │  │        │  │            │  │                   │ │
│  │  │  │ 5️⃣  Go App │  │        │  │ 5️⃣  Go App │  │                   │ │
│  │  │  │ Port: 8080 │  │        │  │ Port: 8080 │  │                   │ │
│  │  │  │            │  │        │  │ Port: 8080 │  │                   │ │
│  │  │  │ /health    │  │        │  │ /health    │  │                   │ │
│  │  │  │ /api/v1/*  │  │        │  │ /api/v1/*  │  │                   │ │
│  │  │  │ /metrics   │  │        │  │ /metrics   │  │                   │ │
│  │  │  └────────────┘  │        │  └────────────┘  │                   │ │
│  │  └──────────────────┘        └──────────────────┘                   │ │
│  │                                                                        │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  Kubernetes 核心组件（在节点上运行）                                    │ │
│  │  - kubelet: 管理 Pod 生命周期                                          │ │
│  │  - kube-proxy: 配置网络规则                                            │ │
│  │  - Container Runtime (Docker): 运行容器                                │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 🎯 关键概念详解

### 1. 什么是"节点"（Node）？

```
节点 = 一台物理机或虚拟机，用于运行 Pod

在你的环境中：
┌────────────────────────────┐
│  物理机（Windows 电脑）      │
│                            │
│  ┌──────────────────────┐  │
│  │  Docker Desktop      │  │
│  │                      │  │
│  │  ┌────────────────┐  │  │
│  │  │ Minikube VM    │  │  │  ← 这就是 "节点"
│  │  │ (虚拟机)        │  │  │
│  │  │                │  │  │
│  │  │ IP: 192.168.49.2│ │  │
│  │  │ 名称: minikube  │  │  │
│  │  └────────────────┘  │  │
│  └──────────────────────┘  │
└────────────────────────────┘

节点的作用：
✅ 提供运行环境（CPU、内存、网络）
✅ 运行 Kubernetes 组件（kubelet、kube-proxy）
✅ 运行你的 Pod
✅ 管理容器（通过 Docker）
```

---

### 2. 节点上有什么？

```
Minikube 节点（192.168.49.2）
├── Kubernetes 组件
│   ├── kubelet        → 管理 Pod（启动、停止、健康检查）
│   ├── kube-proxy     → 配置网络规则（iptables/IPVS）
│   └── container-runtime → Docker（运行容器）
│
├── 网络组件
│   ├── CNI 插件       → 配置 Pod 网络
│   └── iptables 规则  → 流量转发规则
│
├── 你的工作负载
│   ├── Pod 1 (IP: 10.244.0.5)
│   └── Pod 2 (IP: 10.244.0.6)
│
└── Kubernetes 系统 Pod
    ├── kube-dns
    ├── kube-proxy
    └── ...
```

---

## 🌊 完整流量路径（步骤详解）

### 步骤 1: 用户发起请求

```
你在浏览器输入：
http://127.0.0.1:62218/health
或
http://192.168.49.2:30080/health

┌──────────┐
│  浏览器   │  curl http://127.0.0.1:62218/health
└─────┬────┘
      │
      ↓
Windows 本地网络栈（127.0.0.1:62218）
```

---

### 步骤 2: Minikube 隧道转发（如果使用 minikube service）

```
minikube service api-service
  ↓
自动创建隧道: 127.0.0.1:62218 → 192.168.49.2:30080

为什么需要隧道？
┌────────────────────────────────────────────┐
│  Windows 网络：192.168.1.x                  │  ← 你的电脑
└────────────────────────────────────────────┘
              ↕ 网络隔离
┌────────────────────────────────────────────┐
│  Minikube 虚拟网络：192.168.49.x            │  ← 虚拟机
└────────────────────────────────────────────┘

直接访问不通 ❌
通过隧道可以访问 ✅
```

**或者直接访问 NodePort**：
```
curl http://192.168.49.2:30080/health
  ↓
直接到节点的 30080 端口
```

---

### 步骤 3: 到达节点的 NodePort

```
请求到达: 192.168.49.2:30080

Minikube 节点收到请求：
┌───────────────────────────────┐
│  Minikube 节点 (192.168.49.2) │
│                               │
│  监听端口：                    │
│  - 30080 (NodePort)           │
│  - 其他服务端口...            │
└───────────────┬───────────────┘
                │
                ↓
      查询 iptables 规则
```

---

### 步骤 4: iptables 规则匹配 Service

```
节点上的 iptables 规则（由 kube-proxy 维护）：

规则示例：
IF 目标端口 = 30080
THEN 转发到 ClusterIP 10.96.123.45:8080
     (api-service 的 ClusterIP)

┌─────────────────────────────────────┐
│  iptables/IPVS 规则                 │
│                                     │
│  30080 → 10.96.123.45:8080         │
│          (api-service)              │
└──────────────┬──────────────────────┘
               │
               ↓
         Service (api-service)
```

**iptables 规则实际例子**：
```bash
# 在节点上查看（仅示意）
iptables -t nat -L -n | grep 30080

# 输出类似：
DNAT  tcp  --  0.0.0.0/0  0.0.0.0/0  tcp dpt:30080 to:10.96.123.45:8080
```

---

### 步骤 5: Service 选择 Pod

```
Service (api-service)
  ClusterIP: 10.96.123.45
  Port: 8080
  Selector: app=api
  TargetPort: 8080

Service 的工作：
1️⃣  查询 Endpoints
    "哪些 Pod 有 app=api 标签？"
    
    查询结果：
    - 10.244.0.5:8080 (Pod 1) ✅
    - 10.244.0.6:8080 (Pod 2) ✅

2️⃣  负载均衡
    选择一个 Pod（轮询/随机）
    
    这次选择: 10.244.0.5:8080 (Pod 1)

3️⃣  转发流量
    目标: 10.244.0.5:8080
```

**Endpoints 查询**：
```bash
kubectl get endpoints api-service

# 输出：
NAME          ENDPOINTS
api-service   10.244.0.5:8080,10.244.0.6:8080
```

---

### 步骤 6: 流量到达 Pod

```
请求到达: Pod 1 (10.244.0.5:8080)

Pod 内部：
┌────────────────────────────┐
│  Pod (api-server-xxx)      │
│  IP: 10.244.0.5            │
│                            │
│  ┌──────────────────────┐  │
│  │  Container (api)     │  │
│  │  Port: 8080          │  │
│  │                      │  │
│  │  监听 :8080          │  │
│  │    ↓                 │  │
│  │  Go 应用处理请求     │  │
│  └──────────────────────┘  │
└────────────────────────────┘
```

---

### 步骤 7: Go 应用处理请求

```go
// src/main.go
router.GET("/health", handler.HealthCheck)

// 执行 handler.HealthCheck
func HealthCheck(c *gin.Context) {
    c.JSON(http.StatusOK, gin.H{
        "status": "healthy",
        "uptime": time.Since(startTime).String(),
    })
}

// 返回响应：
{
  "status": "healthy",
  "uptime": "5m30s"
}
```

---

### 步骤 8: 响应原路返回

```
响应路径（逆向）：

Go 应用
  ↓
Container (Port 8080)
  ↓
Pod (10.244.0.5:8080)
  ↓
Service (10.96.123.45:8080)
  ↓
iptables 规则转换
  ↓
NodePort (192.168.49.2:30080)
  ↓
Minikube 隧道（如果有）
  ↓
Windows (127.0.0.1:62218)
  ↓
浏览器显示结果 ✅
```

---

## 🔍 网络层次详解

### Layer 1: 物理/虚拟网络

```
┌─────────────────────────────────┐
│  Windows 物理网络               │
│  192.168.1.x                    │
└─────────────────────────────────┘
              ↕
┌─────────────────────────────────┐
│  Docker Bridge 网络             │
│  (NAT)                          │
└─────────────────────────────────┘
              ↕
┌─────────────────────────────────┐
│  Minikube 虚拟机网络            │
│  192.168.49.x                   │
└─────────────────────────────────┘
```

---

### Layer 2: Kubernetes 网络

```
┌─────────────────────────────────┐
│  节点网络                        │
│  192.168.49.2                   │
│  (Node IP)                      │
└─────────────────────────────────┘
              ↕
┌─────────────────────────────────┐
│  Service 网络（虚拟）            │
│  10.96.0.0/12                   │
│  (ClusterIP 范围)               │
└─────────────────────────────────┘
              ↕
┌─────────────────────────────────┐
│  Pod 网络                        │
│  10.244.0.0/16                  │
│  (Pod IP 范围)                  │
└─────────────────────────────────┘
```

---

### Layer 3: 端口映射

```
外部端口               Service 端口          Pod 端口
(NodePort)            (ClusterIP:Port)     (Pod IP:TargetPort)

30080        →        10.96.123.45:8080  →  10.244.0.5:8080
(节点)                 (Service 虚拟IP)      (Pod 实际IP)
```

---

## 💡 重要概念对比

### NodePort vs ClusterIP vs Pod IP

```
NodePort: 30080
  - 在节点上暴露的端口
  - 外部可访问
  - 范围: 30000-32767

ClusterIP: 10.96.123.45:8080
  - Service 的虚拟 IP
  - 只在集群内有效
  - 稳定不变

Pod IP: 10.244.0.5:8080
  - Pod 的实际 IP
  - 只在集群内有效
  - Pod 重启会变
```

---

### Service 的作用

```
没有 Service：
  - 你需要知道每个 Pod 的 IP
  - Pod 重启后 IP 变了，访问就断了 ❌

有 Service：
  - 你只需要知道 Service 名称
  - Service 自动跟踪 Pod IP 变化
  - 自动负载均衡 ✅
```

---

## 🎯 验证流量路径

### 1. 查看节点信息

```powershell
# 查看节点
kubectl get nodes -o wide

# 输出：
NAME       STATUS   ROLES    AGE   VERSION   INTERNAL-IP      OS-IMAGE
minikube   Ready    master   1d    v1.28.3   192.168.49.2     Ubuntu 22.04
                                              ↑ 节点 IP
```

---

### 2. 查看 Service 信息

```powershell
kubectl get svc api-service

# 输出：
NAME          TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
api-service   NodePort   10.96.123.45    <none>        8080:30080/TCP   1h
                         ↑ Service IP              ↑ Service:NodePort
```

---

### 3. 查看 Pod 信息

```powershell
kubectl get pods -o wide

# 输出：
NAME                READY   STATUS    IP            NODE
api-server-xxx      1/1     Running   10.244.0.5    minikube
api-server-yyy      1/1     Running   10.244.0.6    minikube
                                      ↑ Pod IP      ↑ 运行在这个节点
```

---

### 4. 查看 Endpoints

```powershell
kubectl get endpoints api-service

# 输出：
NAME          ENDPOINTS
api-service   10.244.0.5:8080,10.244.0.6:8080
              ↑ Service 找到的 Pod IP 列表
```

---

### 5. 测试访问路径

```powershell
# 方法 1：通过 minikube service（自动隧道）
minikube service api-service
# 自动打开: http://127.0.0.1:62218/...

# 方法 2：直接访问 NodePort
curl http://192.168.49.2:30080/health

# 方法 3：集群内访问（需要进入 Pod）
kubectl run test --image=alpine --rm -it -- sh
wget -qO- http://api-service:8080/health
wget -qO- http://10.244.0.5:8080/health
```

---

## 📊 完整流量追踪

### 使用 tcpdump 追踪（高级）

```bash
# SSH 到 Minikube 节点
minikube ssh

# 监听 NodePort 流量
sudo tcpdump -i any -nn port 30080

# 在另一个终端发送请求
curl http://192.168.49.2:30080/health

# 你会看到：
# 192.168.1.x → 192.168.49.2:30080  （请求到达节点）
# 192.168.49.2 → 10.244.0.5:8080    （转发到 Pod）
# 10.244.0.5:8080 → 192.168.49.2    （Pod 响应）
# 192.168.49.2:30080 → 192.168.1.x  （返回给客户端）
```

---

## 🎓 总结

### 核心概念

```
节点（Node）= 运行 Pod 的机器（物理机或虚拟机）
  - 你的环境中：Minikube VM (192.168.49.2)
  - 作用：提供运行环境、网络、存储

Service = 负载均衡器 + 服务发现
  - 提供稳定的访问入口
  - 自动跟踪 Pod IP 变化
  - 负载均衡到多个 Pod

Pod = 容器的集合
  - 最小部署单元
  - 有自己的 IP
  - 运行你的应用容器
```

---

### 完整流量路径（一句话）

```
浏览器 
  → Minikube 隧道（可选）
  → 节点 NodePort (192.168.49.2:30080)
  → iptables 规则转换
  → Service ClusterIP (10.96.123.45:8080)
  → 负载均衡选择 Pod
  → Pod IP (10.244.0.5:8080)
  → Container 处理请求
  → 响应原路返回
```

---

**现在清楚了吗？** 节点就是运行 Pod 的"地基"，而 Service 是"路由器"，把流量从节点端口导到正确的 Pod！🎯
