# v0.2 æ¶æ„è®¾è®¡æ–‡æ¡£

> CloudNative Go Journey v0.2 - ç¼–æ’å‡çº§ç‰ˆæ¶æ„è¯¦è§£

---

## ğŸ“ æ•´ä½“æ¶æ„

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Minikube é›†ç¾¤                               â”‚
â”‚                                                                â”‚
â”‚  ç”¨æˆ·è¯·æ±‚                                                        â”‚
â”‚     â†“                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  API Service (NodePort 30080)                           â”‚  â”‚
â”‚  â”‚  è´Ÿè½½å‡è¡¡                                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚     â†“                           â†“                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  API Pod 1      â”‚      â”‚  API Pod 2      â”‚                 â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                 â”‚
â”‚  â”‚  â”‚ Gin Web   â”‚  â”‚      â”‚  â”‚ Gin Web   â”‚  â”‚                 â”‚
â”‚  â”‚  â”‚ Server    â”‚  â”‚      â”‚  â”‚ Server    â”‚  â”‚                 â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                 â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                 â”‚
â”‚  â”‚  â”‚ Cache     â”‚â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â–¶â”‚ Cache     â”‚  â”‚                 â”‚
â”‚  â”‚  â”‚ Layer     â”‚  â”‚      â”‚  â”‚ Layer     â”‚  â”‚                 â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                 â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                 â”‚
â”‚  â”‚  â”‚ Config    â”‚  â”‚      â”‚  â”‚ Config    â”‚  â”‚                 â”‚
â”‚  â”‚  â”‚ (EnvVar)  â”‚  â”‚      â”‚  â”‚ (EnvVar)  â”‚  â”‚                 â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚         â”‚                         â”‚                            â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                   â†“                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Redis Service (Headless)                               â”‚  â”‚
â”‚  â”‚  redis-0.redis-service.default.svc.cluster.local        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                   â†“                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚  Redis Pod (redis-0)                   â”‚                   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚                   â”‚
â”‚  â”‚  â”‚  Redis Server                   â”‚    â”‚                   â”‚
â”‚  â”‚  â”‚  - ç«¯å£: 6379                   â”‚    â”‚                   â”‚
â”‚  â”‚  â”‚  - é…ç½®: redis.conf (ConfigMap) â”‚    â”‚                   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚                   â”‚
â”‚  â”‚                 â†“                      â”‚                   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚                   â”‚
â”‚  â”‚  â”‚  PVC (redis-data-redis-0)      â”‚    â”‚                   â”‚
â”‚  â”‚  â”‚  æŒä¹…åŒ–å­˜å‚¨                     â”‚    â”‚                   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  DaemonSet - Log Collector                              â”‚  â”‚
â”‚  â”‚  (æ¯ä¸ª Node ä¸Šè¿è¡Œä¸€ä¸ª)                                  â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚  â”‚
â”‚  â”‚  â”‚ Node 1         â”‚      â”‚ Node 2         â”‚             â”‚  â”‚
â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚      â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚             â”‚  â”‚
â”‚  â”‚  â”‚ â”‚Log         â”‚ â”‚      â”‚ â”‚Log         â”‚ â”‚             â”‚  â”‚
â”‚  â”‚  â”‚ â”‚Collector   â”‚ â”‚      â”‚ â”‚Collector   â”‚ â”‚             â”‚  â”‚
â”‚  â”‚  â”‚ â”‚Pod         â”‚ â”‚      â”‚ â”‚Pod         â”‚ â”‚             â”‚  â”‚
â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚      â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚             â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  CronJob - Cleanup Job                                  â”‚  â”‚
â”‚  â”‚  å®šæ—¶ä»»åŠ¡ï¼šæ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡                                â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚  æ¯å°æ—¶è§¦å‘ â”€â”€â–¶ åˆ›å»º Job â”€â”€â–¶ åˆ›å»º Pod â”€â”€â–¶ æ‰§è¡Œæ¸…ç†      â”‚  â”‚
â”‚  â”‚                                      â”‚                   â”‚  â”‚
â”‚  â”‚                                      â†“                   â”‚  â”‚
â”‚  â”‚                              è¿æ¥ Redis æ¸…ç†è¿‡æœŸæ•°æ®      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 1. API æœåŠ¡ï¼ˆDeploymentï¼‰

#### åŠŸèƒ½èŒè´£
- HTTP API è¯·æ±‚å¤„ç†
- Redis ç¼“å­˜è¯»å†™
- é…ç½®ç®¡ç†
- å¥åº·æ£€æŸ¥
- Prometheus æŒ‡æ ‡æš´éœ²

#### æŠ€æœ¯æ ˆ
```go
- Gin Web æ¡†æ¶
- go-redis/redis å®¢æˆ·ç«¯
- Prometheus client
- Viper é…ç½®ç®¡ç†ï¼ˆå¯é€‰ï¼‰
```

#### K8s èµ„æº
```yaml
èµ„æºç±»å‹: Deployment
å‰¯æœ¬æ•°: 2
èµ„æºé™åˆ¶:
  CPU: 100m - 200m
  å†…å­˜: 128Mi - 256Mi
å¥åº·æ£€æŸ¥:
  Liveness: /health
  Readiness: /ready
ç¯å¢ƒå˜é‡:
  - REDIS_HOST
  - REDIS_PORT
  - APP_ENV
```

#### æ–°å¢æ¥å£

```go
// ç¼“å­˜æµ‹è¯•
GET  /api/v1/cache/test
è¿”å›: {
  "redis_connected": true,
  "cache_hit_rate": 0.85,
  "total_requests": 1000
}

// é…ç½®æŸ¥çœ‹
GET  /api/v1/config
è¿”å›: {
  "app_env": "production",
  "redis_host": "redis-service",
  "version": "v0.2.0"
}

// æ•°æ®å†™å…¥ï¼ˆä¼šå†™å…¥ Redisï¼‰
POST /api/v1/data
Body: {
  "key": "user:123",
  "value": "John Doe",
  "ttl": 3600
}

// æ•°æ®è¯»å–ï¼ˆå…ˆæŸ¥ Redisï¼Œæœªå‘½ä¸­æŸ¥æ•°æ®åº“ï¼‰
GET  /api/v1/data/:key
è¿”å›: {
  "key": "user:123",
  "value": "John Doe",
  "cached": true,
  "timestamp": "2025-10-28T10:00:00Z"
}
```

---

### 2. Redisï¼ˆStatefulSetï¼‰

#### ä¸ºä»€ä¹ˆä½¿ç”¨ StatefulSetï¼Ÿ

```
StatefulSet vs Deployment:

StatefulSet:
âœ… ç¨³å®šçš„ç½‘ç»œæ ‡è¯†ï¼ˆredis-0, redis-1...ï¼‰
âœ… ç¨³å®šçš„æŒä¹…åŒ–å­˜å‚¨ï¼ˆæ¯ä¸ª Pod ç‹¬ç«‹ PVCï¼‰
âœ… æœ‰åºéƒ¨ç½²å’Œæ‰©ç¼©å®¹
âœ… æœ‰åºæ»šåŠ¨æ›´æ–°

Deployment:
âŒ éšæœº Pod åç§°
âŒ Pod é‡å»ºåå­˜å‚¨ä¸¢å¤±ï¼ˆé™¤éæ‰‹åŠ¨é…ç½®ï¼‰
âŒ æ— åºéƒ¨ç½²
```

#### æŒä¹…åŒ–å­˜å‚¨

```yaml
# PVC é…ç½®
volumeClaimTemplates:
  - metadata:
      name: redis-data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 1Gi

# å­˜å‚¨ç›®å½•
å®¹å™¨å†…: /data
å®¿ä¸»æœº: minikube èŠ‚ç‚¹ä¸Šè‡ªåŠ¨åˆ›å»ºçš„ PV
```

#### Headless Service

```yaml
# ä¸ºä»€ä¹ˆéœ€è¦ Headless Serviceï¼Ÿ
clusterIP: None  # å…³é”®ï¼šä¸åˆ†é… ClusterIP

# ç‰¹ç‚¹ï¼š
1. ç›´æ¥è¿”å› Pod IPï¼Œè€Œä¸æ˜¯ VIP
2. æä¾›ç¨³å®šçš„ DNS åç§°
3. æ ¼å¼: <pod-name>.<service-name>.<namespace>.svc.cluster.local

# ç¤ºä¾‹ï¼š
redis-0.redis-service.default.svc.cluster.local
```

#### Redis é…ç½®

```conf
# ConfigMap æŒ‚è½½çš„ redis.conf
bind 0.0.0.0
port 6379
maxmemory 128mb
maxmemory-policy allkeys-lru
save 900 1
save 300 10
save 60 10000
dir /data
```

---

### 3. æ—¥å¿—é‡‡é›†å™¨ï¼ˆDaemonSetï¼‰

#### ä¸ºä»€ä¹ˆä½¿ç”¨ DaemonSetï¼Ÿ

```
åº”ç”¨åœºæ™¯:
âœ… æ—¥å¿—é‡‡é›†ï¼ˆæ¯ä¸ªèŠ‚ç‚¹æ”¶é›†æœ¬èŠ‚ç‚¹æ—¥å¿—ï¼‰
âœ… ç›‘æ§ä»£ç†ï¼ˆæ¯ä¸ªèŠ‚ç‚¹ç›‘æ§èµ„æºï¼‰
âœ… ç½‘ç»œæ’ä»¶ï¼ˆæ¯ä¸ªèŠ‚ç‚¹é…ç½®ç½‘ç»œï¼‰
âœ… å­˜å‚¨æ’ä»¶ï¼ˆæ¯ä¸ªèŠ‚ç‚¹æŒ‚è½½å­˜å‚¨ï¼‰

ç‰¹ç‚¹:
- è‡ªåŠ¨è°ƒåº¦åˆ°æ‰€æœ‰èŠ‚ç‚¹
- æ–°èŠ‚ç‚¹åŠ å…¥è‡ªåŠ¨éƒ¨ç½²
- èŠ‚ç‚¹ç§»é™¤è‡ªåŠ¨æ¸…ç†
```

#### åŠŸèƒ½å®ç°

```go
package main

import (
    "fmt"
    "log"
    "os"
    "time"
)

func main() {
    // è·å–èŠ‚ç‚¹ä¿¡æ¯
    nodeName := os.Getenv("NODE_NAME")
    
    log.Printf("æ—¥å¿—é‡‡é›†å™¨å¯åŠ¨åœ¨èŠ‚ç‚¹: %s", nodeName)
    
    // æ¨¡æ‹Ÿæ—¥å¿—é‡‡é›†
    ticker := time.NewTicker(10 * time.Second)
    defer ticker.Stop()
    
    for range ticker.C {
        // é‡‡é›†èŠ‚ç‚¹æ—¥å¿—
        logs := collectLogs(nodeName)
        
        // è¾“å‡ºæ—¥å¿—ï¼ˆå®é™…åœºæ™¯ä¼šå‘é€åˆ°æ—¥å¿—ä¸­å¿ƒï¼‰
        fmt.Printf("[%s] é‡‡é›†åˆ° %d æ¡æ—¥å¿—\n", nodeName, len(logs))
    }
}

func collectLogs(nodeName string) []string {
    // ç®€åŒ–å®ç°ï¼šè¯»å–ç‰¹å®šè·¯å¾„çš„æ—¥å¿—
    // å®é™…åœºæ™¯ä¼šè¯»å– /var/log/ ç­‰è·¯å¾„
    return []string{"log1", "log2", "log3"}
}
```

#### K8s é…ç½®ç‰¹ç‚¹

```yaml
# èŠ‚ç‚¹é€‰æ‹©å™¨ï¼ˆå¯é€‰ï¼‰
nodeSelector:
  kubernetes.io/os: linux

# å®¹å¿æ±¡ç‚¹ï¼ˆè®©å®ƒèƒ½éƒ¨ç½²åˆ°æ‰€æœ‰èŠ‚ç‚¹ï¼‰
tolerations:
- effect: NoSchedule
  operator: Exists

# æŒ‚è½½å®¿ä¸»æœºè·¯å¾„ï¼ˆè¯»å–æ—¥å¿—ï¼‰
volumeMounts:
- name: varlog
  mountPath: /var/log
  readOnly: true
volumes:
- name: varlog
  hostPath:
    path: /var/log
```

---

### 4. æ¸…ç†ä»»åŠ¡ï¼ˆCronJobï¼‰

#### å®šæ—¶ä»»åŠ¡é…ç½®

```yaml
schedule: "0 * * * *"  # æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ åˆ†é’Ÿ (0 - 59)
# â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å°æ—¶ (0 - 23)
# â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ—¥ (1 - 31)
# â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æœˆ (1 - 12)
# â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ˜ŸæœŸ (0 - 6) (0 = å‘¨æ—¥)
# â”‚ â”‚ â”‚ â”‚ â”‚
# * * * * *

# å¸¸ç”¨ç¤ºä¾‹ï¼š
# "0 * * * *"     - æ¯å°æ—¶
# "*/15 * * * *"  - æ¯ 15 åˆ†é’Ÿ
# "0 2 * * *"     - æ¯å¤©å‡Œæ™¨ 2 ç‚¹
# "0 0 * * 0"     - æ¯å‘¨æ—¥å‡Œæ™¨
```

#### Job é…ç½®

```yaml
# å†å²ä¿ç•™
successfulJobsHistoryLimit: 3  # ä¿ç•™ 3 ä¸ªæˆåŠŸçš„ Job
failedJobsHistoryLimit: 1      # ä¿ç•™ 1 ä¸ªå¤±è´¥çš„ Job

# é‡è¯•ç­–ç•¥
backoffLimit: 3                # å¤±è´¥é‡è¯• 3 æ¬¡
restartPolicy: OnFailure       # å¤±è´¥æ—¶é‡å¯

# è¶…æ—¶è®¾ç½®
activeDeadlineSeconds: 300     # 5 åˆ†é’Ÿè¶…æ—¶
```

#### æ¸…ç†é€»è¾‘

```go
package main

import (
    "context"
    "log"
    "time"
    
    "github.com/go-redis/redis/v8"
)

func main() {
    // è¿æ¥ Redis
    rdb := redis.NewClient(&redis.Options{
        Addr: "redis-service:6379",
    })
    
    ctx := context.Background()
    
    // æ¸…ç†è¿‡æœŸæ•°æ®ï¼ˆç¤ºä¾‹ï¼‰
    log.Println("å¼€å§‹æ¸…ç†è¿‡æœŸæ•°æ®...")
    
    // 1. æ¸…ç†è¿‡æœŸçš„ç¼“å­˜é”®
    keys, _ := rdb.Keys(ctx, "cache:*").Result()
    cleaned := 0
    
    for _, key := range keys {
        ttl := rdb.TTL(ctx, key).Val()
        if ttl < 0 {  // å·²è¿‡æœŸ
            rdb.Del(ctx, key)
            cleaned++
        }
    }
    
    log.Printf("æ¸…ç†å®Œæˆï¼Œåˆ é™¤äº† %d ä¸ªè¿‡æœŸé”®", cleaned)
}
```

---

## ğŸ”„ æ•°æ®æµè¯¦è§£

### 1. API è¯·æ±‚æµç¨‹

```
ç”¨æˆ· â”€â”€â–¶ NodePort (30080) â”€â”€â–¶ Service â”€â”€â–¶ è´Ÿè½½å‡è¡¡
                                           â”‚
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â†“                                       â†“
                 API Pod 1                              API Pod 2
                     â”‚                                       â”‚
                     â”œâ”€ æŸ¥è¯¢ç¼“å­˜ â”€â”€â–¶ Redis â—€â”€â”€ æŸ¥è¯¢ç¼“å­˜ â”€â”€â”€â”€â”€â”¤
                     â”‚                                       â”‚
                     â””â”€ è¿”å›ç»“æœ                  è¿”å›ç»“æœ â”€â”€â”€â”˜
```

### 2. ç¼“å­˜è¯»å–æµç¨‹

```go
// ä¼ªä»£ç 
func GetData(key string) (string, error) {
    // 1. å…ˆæŸ¥ Redis
    value, err := redisClient.Get(ctx, key).Result()
    if err == nil {
        return value, nil  // ç¼“å­˜å‘½ä¸­
    }
    
    // 2. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“ï¼ˆæ¨¡æ‹Ÿï¼‰
    value = queryFromDatabase(key)
    
    // 3. å†™å…¥ç¼“å­˜
    redisClient.Set(ctx, key, value, 1*time.Hour)
    
    return value, nil
}
```

### 3. å®šæ—¶æ¸…ç†æµç¨‹

```
CronJob æ§åˆ¶å™¨ â”€â”€â–¶ æ¯å°æ—¶æ£€æŸ¥æ—¶é—´
                      â”‚
                      â†“
                 åˆ›å»º Job
                      â”‚
                      â†“
                 åˆ›å»º Pod
                      â”‚
                      â†“
              æ‰§è¡Œæ¸…ç†è„šæœ¬ â”€â”€â–¶ è¿æ¥ Redis â”€â”€â–¶ åˆ é™¤è¿‡æœŸæ•°æ®
                      â”‚
                      â†“
               Pod å®Œæˆ (Completed)
                      â”‚
                      â†“
              Job æ ‡è®°æˆåŠŸ
```

---

## ğŸŒ ç½‘ç»œé€šä¿¡è¯¦è§£

### Service ä¹‹é—´çš„é€šä¿¡

```
API Pod è®¿é—® Redis:

æ–¹å¼ 1: é€šè¿‡ Service DNS
redisClient.Connect("redis-service:6379")
â†“
K8s DNS è§£æ: redis-service.default.svc.cluster.local
â†“
è¿”å› Headless Serviceï¼ˆRedis Pod IPï¼‰
â†“
ç›´è¿ Redis Pod

æ–¹å¼ 2: é€šè¿‡ç¯å¢ƒå˜é‡
REDIS_SERVICE_HOST=10.96.xxx.xxx
REDIS_SERVICE_PORT=6379
```

### ConfigMap æ³¨å…¥æ–¹å¼

```yaml
# æ–¹å¼ 1: ç¯å¢ƒå˜é‡
env:
- name: REDIS_HOST
  valueFrom:
    configMapKeyRef:
      name: api-config
      key: redis.host

# æ–¹å¼ 2: æ–‡ä»¶æŒ‚è½½
volumes:
- name: config
  configMap:
    name: redis-config
volumeMounts:
- name: config
  mountPath: /etc/redis/redis.conf
  subPath: redis.conf
```

---

## ğŸ’¾ å­˜å‚¨æ¶æ„

### PV/PVC/StorageClass å…³ç³»

```
StorageClass (æ ‡å‡†å­˜å‚¨ç±»)
    â†“ (åŠ¨æ€åˆ›å»º)
PV (æŒä¹…å· - 1Gi)
    â†“ (ç»‘å®š)
PVC (æŒä¹…å·å£°æ˜ - redis-data-redis-0)
    â†“ (æŒ‚è½½)
Pod (redis-0)
    â†“
å®¹å™¨ /data ç›®å½•
```

### æ•°æ®æŒä¹…åŒ–éªŒè¯

```bash
# 1. å†™å…¥æ•°æ®
kubectl exec -it redis-0 -- redis-cli SET test "hello"

# 2. åˆ é™¤ Pod
kubectl delete pod redis-0

# 3. ç­‰å¾… Pod é‡å»º
kubectl get pods -w

# 4. éªŒè¯æ•°æ®è¿˜åœ¨
kubectl exec -it redis-0 -- redis-cli GET test
# è¾“å‡º: "hello" âœ…
```

---

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

### API æœåŠ¡æŒ‡æ ‡

```prometheus
# ç¼“å­˜å‘½ä¸­ç‡
cache_hit_rate = cache_hits / (cache_hits + cache_misses)

# Redis è¿æ¥çŠ¶æ€
redis_connected{pod="api-pod-1"} 1

# ç¼“å­˜æ“ä½œå»¶è¿Ÿ
cache_operation_duration_seconds{operation="get"} 0.002
cache_operation_duration_seconds{operation="set"} 0.001
```

### Redis æŒ‡æ ‡

```prometheus
# å†…å­˜ä½¿ç”¨
redis_memory_used_bytes{pod="redis-0"} 12345678

# è¿æ¥æ•°
redis_connected_clients{pod="redis-0"} 2

# å‘½ä»¤æ‰§è¡Œæ¬¡æ•°
redis_commands_total{cmd="get"} 1000
redis_commands_total{cmd="set"} 500
```

### æ¸…ç†ä»»åŠ¡æŒ‡æ ‡

```prometheus
# ä»»åŠ¡æ‰§è¡Œæ¬¡æ•°
cleanup_job_runs_total 24

# æ¸…ç†çš„é”®æ•°é‡
cleanup_keys_deleted_total 150
```

---

## ğŸ” å®‰å…¨è€ƒè™‘

### Redis å¯†ç ï¼ˆå¯é€‰ï¼‰

```yaml
# Secret å­˜å‚¨å¯†ç 
apiVersion: v1
kind: Secret
metadata:
  name: redis-secret
type: Opaque
data:
  password: cGFzc3dvcmQxMjM=  # base64("password123")

# æ³¨å…¥åˆ° Pod
env:
- name: REDIS_PASSWORD
  valueFrom:
    secretKeyRef:
      name: redis-secret
      key: password
```

### èµ„æºéš”ç¦»

```yaml
# ä½¿ç”¨ namespace éš”ç¦»
kubectl create namespace app-v02

# ç½‘ç»œç­–ç•¥ï¼ˆå¯é€‰ï¼Œv0.4 è¯¦ç»†è®²ï¼‰
# é™åˆ¶åªæœ‰ API Pod èƒ½è®¿é—® Redis
```

---

## ğŸ¯ æ¶æ„ä¼˜åŠ¿

### v0.1 vs v0.2 å¯¹æ¯”

| ç‰¹æ€§ | v0.1 | v0.2 |
|------|------|------|
| å·¥ä½œè´Ÿè½½ç±»å‹ | 1 ç§ (Deployment) | 4 ç§ (Deployment, StatefulSet, DaemonSet, CronJob) |
| æŒä¹…åŒ–å­˜å‚¨ | âŒ | âœ… (PVC) |
| é…ç½®ç®¡ç† | ç¯å¢ƒå˜é‡ | ConfigMap/Secret |
| å¤–éƒ¨ä¾èµ– | âŒ | âœ… (Redis) |
| å®šæ—¶ä»»åŠ¡ | âŒ | âœ… (CronJob) |
| èŠ‚ç‚¹çº§æœåŠ¡ | âŒ | âœ… (DaemonSet) |

---

## ğŸ“ˆ æ‰©å±•æ€§è€ƒè™‘

### æœªæ¥æ‰©å±•æ–¹å‘

```
v0.2 â†’ v0.3:
- Redis æ”¹ä¸ºä¸»ä»æ¶æ„ï¼ˆå¤šå‰¯æœ¬ï¼‰
- HPA è‡ªåŠ¨æ‰©ç¼©å®¹
- æ·»åŠ æ•°æ®åº“ï¼ˆPostgreSQL StatefulSetï¼‰

v0.2 â†’ v0.4:
- æ·»åŠ  Ingressï¼ˆç»Ÿä¸€å…¥å£ï¼‰
- æœåŠ¡ç½‘æ ¼ï¼ˆIstioï¼‰
- å¤šæœåŠ¡æ¶æ„
```

---

## ğŸ“ å­¦ä¹ è¦ç‚¹æ€»ç»“

é€šè¿‡ v0.2 æ¶æ„ï¼Œä½ å°†æ·±å…¥ç†è§£ï¼š

âœ… **K8s å¤šç§å·¥ä½œè´Ÿè½½çš„é€‚ç”¨åœºæ™¯**  
âœ… **æœ‰çŠ¶æ€åº”ç”¨çš„éƒ¨ç½²å’Œç®¡ç†**  
âœ… **æŒä¹…åŒ–å­˜å‚¨çš„ä½¿ç”¨**  
âœ… **é…ç½®å’Œå¯†é’¥çš„ç®¡ç†**  
âœ… **å®šæ—¶ä»»åŠ¡çš„å®ç°**  
âœ… **èŠ‚ç‚¹çº§æœåŠ¡çš„éƒ¨ç½²**  
âœ… **æœåŠ¡é—´é€šä¿¡å’Œå‘ç°**  

---

**æ¶æ„è®¾è®¡å®Œæˆï¼å‡†å¤‡å¼€å§‹å®æ–½ï¼** ğŸš€


