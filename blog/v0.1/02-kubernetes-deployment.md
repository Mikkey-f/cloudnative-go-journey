# ä»é›¶å¼€å§‹çš„äº‘åŸç”Ÿä¹‹æ—…ï¼ˆäºŒï¼‰ï¼šç¬¬ä¸€æ¬¡éƒ¨ç½²åˆ° K8s

> Kubernetes é›¶åŸºç¡€åˆ°æˆåŠŸéƒ¨ç½² | è®°å½•æ‰€æœ‰è¸©è¿‡çš„å‘

## æ–‡ç« ç›®å½•

- å‰è¨€
- ä¸€ã€K8s æ˜¯ä¸ªå•¥ï¼Ÿï¼ˆ5 åˆ†é’Ÿé€Ÿæˆï¼‰
  - 1.1 ä¸ºä»€ä¹ˆéœ€è¦ K8s
  - 1.2 ä¸‰ä¸ªæ ¸å¿ƒæ¦‚å¿µ
  - 1.3 æµç¨‹å›¾è§£
- äºŒã€ç¯å¢ƒå‡†å¤‡
  - 2.1 å®‰è£… Minikube
  - 2.2 å¯åŠ¨æœ¬åœ°é›†ç¾¤
- ä¸‰ã€ç¼–å†™ K8s é…ç½®
  - 3.1 Deployment - å‘Šè¯‰ K8s è¿è¡Œä»€ä¹ˆ
  - 3.2 Service - å‘Šè¯‰ K8s æ€ä¹ˆè®¿é—®
  - 3.3 ä¸¤è€…çš„å…³ç³»
- å››ã€éƒ¨ç½²å®æˆ˜
  - 4.1 é•œåƒåŠ è½½ï¼ˆç¬¬ä¸€ä¸ªå¤§å‘ï¼‰
  - 4.2 åº”ç”¨éƒ¨ç½²
  - 4.3 è®¿é—®æœåŠ¡
- äº”ã€è¸©å‘å®å½•
  - 5.1 ImagePullBackOffï¼ˆé•œåƒæ‰¾ä¸åˆ°ï¼‰
  - 5.2 æ ‡ç­¾ä¸åŒ¹é…ï¼ˆService æ‰¾ä¸åˆ° Podï¼‰
  - 5.3 è´Ÿè½½å‡è¡¡çš„å¤§å‘ç°
- å…­ã€éªŒè¯å’Œæµ‹è¯•
- ç»“è¯­

---

## å‰è¨€

ä¸Šä¸€ç¯‡ã€ŠæŠŠ Go åº”ç”¨å¡è¿› Dockerã€‹ä¸­ï¼Œæˆ‘æˆåŠŸæŠŠé•œåƒä¼˜åŒ–åˆ°äº† 16MBã€‚

**ç°åœ¨é¢ä¸´æ–°é—®é¢˜**ï¼š
- é•œåƒæœ‰äº†ï¼Œæ€ä¹ˆéƒ¨ç½²ï¼Ÿ
- å¬è¯´ Kubernetes å¾ˆå¼ºå¤§ï¼Œä½†å®Œå…¨ä¸ä¼š
- ç½‘ä¸Šæ•™ç¨‹éƒ½æ˜¯å‘½ä»¤è¡Œï¼Œçœ‹ä¸æ‡‚åœ¨å¹²å•¥

**æˆ‘çš„æƒ…å†µ**ï¼š
- âœ… ä¼š Go
- âœ… ä¼š Docker åŸºç¡€
- âŒ Kubernetes é›¶åŸºç¡€
- âŒ ä¸çŸ¥é“ Podã€Deploymentã€Service æ˜¯å•¥

å¦‚æœä½ ä¹Ÿæ˜¯è¿™æ ·ï¼Œè¿™ç¯‡æ–‡ç« é€‚åˆä½ ï¼æˆ‘ä¼šç”¨**æœ€ç™½è¯çš„æ–¹å¼**è®²æ¸…æ¥š K8sã€‚

---

## ä¸€ã€K8s æ˜¯ä¸ªå•¥ï¼Ÿï¼ˆ5 åˆ†é’Ÿé€Ÿæˆï¼‰

### 1.1 ä¸ºä»€ä¹ˆéœ€è¦ K8s

æˆ‘ä¹‹å‰ç”¨ Docker éƒ¨ç½²æ˜¯è¿™æ ·çš„ï¼š

```bash
# æœåŠ¡å™¨ 1
docker run -d -p 8080:8080 my-api:v1

# æœåŠ¡å™¨ 2  
docker run -d -p 8080:8080 my-api:v1

# é—®é¢˜æ¥äº†ï¼š
âŒ å®¹å™¨æŒ‚äº†ï¼Œè¦æ‰‹åŠ¨é‡å¯
âŒ æµé‡æ€ä¹ˆåˆ†é…åˆ° 2 å°æœåŠ¡å™¨ï¼Ÿ
âŒ æƒ³æ‰©å®¹åˆ° 10 ä¸ªå®¹å™¨ï¼Ÿæ‰‹åŠ¨è¿è¡Œ 10 æ¬¡ï¼Ÿ
âŒ æ»šåŠ¨æ›´æ–°ï¼Ÿå…ˆåœ 1 ä¸ªï¼Œå¯åŠ¨æ–°çš„ï¼Œå†åœä¸‹ä¸€ä¸ª...æ‰‹åŠ¨ï¼Ÿ
```

**Kubernetes å°±æ˜¯è§£å†³è¿™äº›é—®é¢˜çš„**ï¼š
```
ä½ å‘Šè¯‰ K8sï¼š"æˆ‘è¦ 2 ä¸ªå®¹å™¨"
K8s è‡ªåŠ¨ï¼š
âœ… åˆ›å»º 2 ä¸ªå®¹å™¨
âœ… ç›‘æ§çŠ¶æ€ï¼ŒæŒ‚äº†è‡ªåŠ¨é‡å¯
âœ… è´Ÿè½½å‡è¡¡ï¼ˆè‡ªåŠ¨åˆ†é…æµé‡ï¼‰
âœ… æ»šåŠ¨æ›´æ–°ï¼ˆè‡ªåŠ¨æ›¿æ¢æ—§ç‰ˆæœ¬ï¼‰
âœ… æ‰©ç¼©å®¹ï¼ˆæ”¹ä¸ªæ•°å­—å°±è¡Œï¼‰
```

**ç®€å•è¯´**ï¼šK8s = Docker çš„è‡ªåŠ¨åŒ–ç®¡ç†å·¥å…·ã€‚

---

### 1.2 ä¸‰ä¸ªæ ¸å¿ƒæ¦‚å¿µ

å­¦ K8s ä¹‹å‰ï¼Œæˆ‘è§‰å¾—æ¦‚å¿µå¤ªå¤šäº†ã€‚åæ¥å‘ç°ï¼Œ**å…¥é—¨åªéœ€è¦ææ‡‚ 3 ä¸ª**ï¼š

#### **æ¦‚å¿µ 1ï¼šPodï¼ˆæœ€å°å•ä½ï¼‰**

```
Pod = ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨çš„ç»„åˆ

ä½ çš„ Docker å®¹å™¨ â†’ è¿è¡Œåœ¨ Pod é‡Œ
Pod æœ‰è‡ªå·±çš„ IPï¼ˆ10.244.0.5ï¼‰
Pod æ˜¯ä¸´æ—¶çš„ï¼ˆéšæ—¶å¯èƒ½è¢«åˆ é™¤é‡å»ºï¼‰

ç±»æ¯”ï¼š
Pod = å¿«é€’ç›’
å®¹å™¨ = å¿«é€’ç›’é‡Œçš„å•†å“
```

**å›¾ç¤º**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Pod         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Containerâ”‚   â”‚  â† ä½ çš„ Go ç¨‹åº
â”‚  â”‚(my-api)  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  IP: 10.244.0.5 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### **æ¦‚å¿µ 2ï¼šDeploymentï¼ˆPod ç®¡ç†å™¨ï¼‰**

```
Deployment = ç®¡ç† Pod çš„å·¥å…·

ä½ è¯´ï¼šæˆ‘è¦ 2 ä¸ª Pod
Deployment åšï¼š
  - åˆ›å»º 2 ä¸ª Pod
  - Pod æŒ‚äº†ï¼Ÿè‡ªåŠ¨é‡å¯
  - è¦æ›´æ–°ï¼Ÿè‡ªåŠ¨æ»šåŠ¨æ›´æ–°
  - è¦æ‰©å®¹ï¼Ÿè‡ªåŠ¨åˆ›å»ºæ–° Pod

ç±»æ¯”ï¼š
Deployment = å·¥å‚å‚é•¿
Pod = å·¥äºº
```

**å›¾ç¤º**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Deployment               â”‚
â”‚   "æˆ‘è¦ 2 ä¸ª Pod"          â”‚
â”‚                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  Pod 1   â”‚ â”‚  Pod 2   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### **æ¦‚å¿µ 3ï¼šServiceï¼ˆè´Ÿè½½å‡è¡¡å™¨ï¼‰**

```
é—®é¢˜ï¼šPod IP ä¼šå˜
Pod 1: 10.244.0.5  â† é‡å¯å
Pod 1: 10.244.0.8  â† IP å˜äº†ï¼æ€ä¹ˆè®¿é—®ï¼Ÿ

Service = ç¨³å®šçš„è®¿é—®å…¥å£
- æä¾›å›ºå®šçš„ IP å’ŒåŸŸå
- è‡ªåŠ¨æ‰¾åˆ°åé¢çš„ Pod
- è‡ªåŠ¨è´Ÿè½½å‡è¡¡

ç±»æ¯”ï¼š
Service = å…¬å¸å‰å°
Pod = å…·ä½“çš„å‘˜å·¥
æ‰¾äºº â†’ å…ˆæ‰¾å‰å° â†’ å‰å°å¸®ä½ è½¬æ¥
```

**å›¾ç¤º**ï¼š
```
å¤–éƒ¨è¯·æ±‚
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Service            â”‚
â”‚  (api-service)      â”‚
â”‚  IP: 10.96.123.45   â”‚  â† å›ºå®šä¸å˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚ è´Ÿè½½å‡è¡¡
     â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
     â†“         â†“
  Pod 1     Pod 2
(IP ä¼šå˜) (IP ä¼šå˜)
```

**å°±è¿™ 3 ä¸ªæ¦‚å¿µ**ï¼Œå¤Ÿç”¨äº†ï¼å…¶ä»–çš„è¾¹åšè¾¹å­¦ã€‚

---

### 1.3 æµç¨‹å›¾è§£

**å®Œæ•´çš„è¯·æ±‚æµç¨‹**ï¼š

```
ç”¨æˆ·æµè§ˆå™¨
    â†“
http://192.168.49.2:30080/health  â† NodePortï¼ˆèŠ‚ç‚¹ç«¯å£ï¼Œå¯¹å¤–æš´éœ²ï¼‰
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Minikube èŠ‚ç‚¹                    â”‚
â”‚  (ä½ çš„æœ¬åœ° K8s é›†ç¾¤)              â”‚
â”‚                                  â”‚
â”‚  Service (api-service)           â”‚
â”‚  "æˆ‘æ¥è´Ÿè½½å‡è¡¡"                   â”‚
â”‚      â†“                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                     â”‚
â”‚  â†“         â†“                     â”‚
â”‚ Pod 1    Pod 2                   â”‚
â”‚ (ä½ çš„   (ä½ çš„                     â”‚
â”‚  å®¹å™¨)   å®¹å™¨)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€ç¯å¢ƒå‡†å¤‡

### 2.1 å®‰è£… Minikube

Minikube = æœ¬åœ°çš„ K8s é›†ç¾¤ï¼ˆç”¨äºå­¦ä¹ å’Œå¼€å‘ï¼‰

```powershell
# Windows å®‰è£…
choco install minikube

# æˆ–ä¸‹è½½å®‰è£…åŒ…
https://minikube.sigs.k8s.io/docs/start/
```

### 2.2 å¯åŠ¨æœ¬åœ°é›†ç¾¤

```bash
minikube start --cpus=2 --memory=4096

# ç­‰å¾…å¯åŠ¨...
# ğŸ˜„  Microsoft Windows 10 ä¸Šçš„ minikube v1.32.0
# âœ¨  è‡ªåŠ¨é€‰æ‹© docker é©±åŠ¨
# ğŸ³  æ­£åœ¨å‡†å¤‡ Kubernetes v1.28.3...
# ğŸ„  Done! kubectl is now configured to use "minikube"

# éªŒè¯
kubectl get nodes
# NAME       STATUS   ROLES           AGE   VERSION
# minikube   Ready    control-plane   1m    v1.28.3
```

âœ… é›†ç¾¤å¯åŠ¨æˆåŠŸï¼

---

## ä¸‰ã€ç¼–å†™ K8s é…ç½®

K8s ç”¨ YAML æ–‡ä»¶é…ç½®ï¼Œæˆ‘éœ€è¦å†™ 2 ä¸ªæ–‡ä»¶ã€‚

### 3.1 Deployment - å‘Šè¯‰ K8s è¿è¡Œä»€ä¹ˆ

åˆ›å»ºæ–‡ä»¶ï¼š`k8s/v0.1/deployment.yaml`

```yaml
apiVersion: apps/v1
kind: Deployment          # ç±»å‹ï¼šDeployment
metadata:
  name: api-server        # Deployment çš„åå­—
spec:
  replicas: 2             # æˆ‘è¦ 2 ä¸ª Podï¼ˆé‡ç‚¹ï¼ï¼‰
  
  selector:               # æˆ‘ç®¡ç†å“ªäº› Podï¼Ÿ
    matchLabels:
      app: api            # æˆ‘ç®¡ç† app=api çš„ Pod
  
  template:               # Pod æ¨¡æ¿ï¼ˆæ€ä¹ˆåˆ›å»º Podï¼‰
    metadata:
      labels:
        app: api          # ç»™ Pod æ‰“æ ‡ç­¾ï¼ˆé‡è¦ï¼åé¢ä¼šç”¨åˆ°ï¼‰
    spec:
      containers:
      - name: api
        image: cloudnative-go-api:v0.1  # æˆ‘çš„é•œåƒ
        imagePullPolicy: IfNotPresent   # æœ¬åœ°é•œåƒï¼ˆé‡è¦ï¼ï¼‰
        
        ports:
        - containerPort: 8080
        
        # èµ„æºé™åˆ¶ï¼ˆé˜²æ­¢ä¸€ä¸ª Pod å ç”¨æ‰€æœ‰èµ„æºï¼‰
        resources:
          requests:
            memory: "64Mi"
            cpu: "100m"
          limits:
            memory: "128Mi"
            cpu: "200m"
        
        # å¥åº·æ£€æŸ¥ï¼ˆK8s ä¼šå®šæœŸè®¿é—®è¿™äº›æ¥å£ï¼‰
        livenessProbe:           # å­˜æ´»æ£€æŸ¥
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 10  # å¯åŠ¨åç­‰ 10 ç§’å†æ£€æŸ¥
          periodSeconds: 10        # æ¯ 10 ç§’æ£€æŸ¥ä¸€æ¬¡
        
        readinessProbe:          # å°±ç»ªæ£€æŸ¥
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
```

**å…³é”®ç‚¹æ ‡æ³¨**ï¼š
```
replicas: 2             â† æƒ³è¦å‡ ä¸ª Pod
selector.app: api       â† Deployment ç®¡ç†å“ªäº› Pod
template.labels.app: api â† Pod çš„æ ‡ç­¾ï¼ˆå¿…é¡»å’Œä¸Šé¢åŒ¹é…ï¼ï¼‰
imagePullPolicy: IfNotPresent  â† ç”¨æœ¬åœ°é•œåƒï¼ˆé‡è¦ï¼ï¼‰
```

---

### 3.2 Service - å‘Šè¯‰ K8s æ€ä¹ˆè®¿é—®

åˆ›å»ºæ–‡ä»¶ï¼š`k8s/v0.1/service.yaml`

```yaml
apiVersion: v1
kind: Service
metadata:
  name: api-service
spec:
  type: NodePort        # ç±»å‹ï¼šèŠ‚ç‚¹ç«¯å£ï¼ˆæœ¬åœ°å¼€å‘ç”¨ï¼‰
  
  selector:             # é€‰æ‹©å“ªäº› Podï¼Ÿ
    app: api            # é€‰æ‹© app=api çš„ Podï¼ˆå’Œ Deployment çš„æ ‡ç­¾å¯¹åº”ï¼ï¼‰
  
  ports:
  - port: 8080          # Service ç«¯å£
    targetPort: 8080    # Pod ç«¯å£
    nodePort: 30080     # èŠ‚ç‚¹ç«¯å£ï¼ˆ30000-32767ï¼‰
```

**å…³é”®è¿æ¥ç‚¹**ï¼š
```yaml
# Service é€šè¿‡è¿™ä¸ªæ‰¾ Pod
Service:
  selector:
    app: api      â† å…³é”®ï¼šé€‰æ‹©æ ‡ç­¾

# Deployment ç»™ Pod æ‰“äº†è¿™ä¸ªæ ‡ç­¾
Deployment:
  template:
    metadata:
      labels:
        app: api  â† å…³é”®ï¼šPod æ ‡ç­¾

# ä¸¤è€…é€šè¿‡æ ‡ç­¾è¿æ¥ï¼
```

---

### 3.3 ä¸¤è€…çš„å…³ç³»

**ç”¨å›¾ç†è§£**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Service (api-service)       â”‚
â”‚  "æˆ‘è´Ÿè´£æ¥æ”¶æµé‡"            â”‚
â”‚                              â”‚
â”‚  selector: app=api           â”‚
â”‚  "æˆ‘è¦æ‰¾ app=api çš„ Pod"     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ é€šè¿‡æ ‡ç­¾é€‰æ‹©
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Deployment (api-server)     â”‚
â”‚  "æˆ‘è´Ÿè´£ç®¡ç† Pod"            â”‚
â”‚                              â”‚
â”‚  replicas: 2                 â”‚
â”‚  template.labels: app=api    â”‚
â”‚  "æˆ‘åˆ›å»ºçš„ Pod æœ‰è¿™ä¸ªæ ‡ç­¾"   â”‚
â”‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Pod 1   â”‚  â”‚ Pod 2   â”‚   â”‚
â”‚  â”‚app=api  â”‚  â”‚app=api  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æµé‡æµå‘ï¼š
ç”¨æˆ· â†’ Service â†’ é€‰æ‹© Pod â†’ è½¬å‘è¯·æ±‚
```

**è®°ä½**ï¼šDeployment å’Œ Service é€šè¿‡**æ ‡ç­¾ï¼ˆlabelsï¼‰**è¿æ¥ï¼

---

## å››ã€éƒ¨ç½²å®æˆ˜

### 4.1 é•œåƒåŠ è½½ï¼ˆç¬¬ä¸€ä¸ªå¤§å‘ï¼‰âš ï¸

æˆ‘å¤©çœŸåœ°ä»¥ä¸ºï¼š

```bash
# 1. æœ¬åœ°æ„å»ºé•œåƒ
docker build -t cloudnative-go-api:v0.1 .

# 2. ç›´æ¥éƒ¨ç½²åˆ° K8s
kubectl apply -f k8s/v0.1/

# 3. åº”è¯¥å°±èƒ½è·‘äº†å§ï¼Ÿ
```

**ç»“æœ**ï¼š

```bash
kubectl get pods

# NAME                READY   STATUS             RESTARTS   AGE
# api-server-xxx      0/1     ImagePullBackOff   0          2m
#                             â†‘ è¿™æ˜¯å•¥ï¼Ÿ
```

**ImagePullBackOff** = é•œåƒæ‹‰å–å¤±è´¥ï¼Œä¸æ–­é‡è¯•ã€‚

**æˆ‘æŸ¥æ—¥å¿—**ï¼š
```bash
kubectl describe pod api-server-xxx

# Events:
#   Warning  Failed   Failed to pull image "cloudnative-go-api:v0.1": 
#            rpc error: code = Unknown desc = Error response from daemon: 
#            pull access denied, repository does not exist or may require 'docker login'
```

**æ‡µäº†**ï¼šé•œåƒæ˜æ˜åœ¨æœ¬åœ° Docker é‡Œå•Šï¼

---

**çœŸç›¸**ï¼š

```
Docker Desktop çš„é•œåƒ
     â†•  ä¸åŒçš„ç¯å¢ƒï¼
Minikube çš„ Docker

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Windows æœ¬æœº        â”‚
â”‚  Docker Desktop      â”‚
â”‚  é•œåƒ: my-api âœ…     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†• éš”ç¦»ï¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Minikube VM         â”‚
â”‚  ç‹¬ç«‹çš„ Docker       â”‚
â”‚  é•œåƒ: ç©º âŒ         â”‚  â† Minikube é‡Œæ²¡æœ‰é•œåƒï¼
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è§£å†³æ–¹æ³•**ï¼šæŠŠé•œåƒåŠ è½½åˆ° Minikube

```bash
# å…³é”®å‘½ä»¤ï¼
minikube image load cloudnative-go-api:v0.1

# éªŒè¯
minikube image ls | grep cloudnative
# çœ‹åˆ°é•œåƒäº† âœ…
```

**è¿™ä¸ªå‘æµªè´¹äº†æˆ‘ 30 åˆ†é’Ÿï¼** ğŸ˜­

---

### 4.2 åº”ç”¨éƒ¨ç½²

é•œåƒåŠ è½½å¥½åï¼Œå¼€å§‹éƒ¨ç½²ï¼š

```bash
# åº”ç”¨é…ç½®æ–‡ä»¶
kubectl apply -f k8s/v0.1/

# è¾“å‡ºï¼š
# deployment.apps/api-server created
# service/api-service created

# æŸ¥çœ‹ Pod
kubectl get pods

# ç­‰å¾…çŠ¶æ€å˜æˆ Running...
# NAME                          READY   STATUS    RESTARTS   AGE
# api-server-59dfcf76d4-26psx   1/1     Running   0          30s
# api-server-59dfcf76d4-nlj5w   1/1     Running   0          30s
```

**çœ‹åˆ° 2 ä¸ª Pod éƒ½æ˜¯ Running**ï¼Œæ¿€åŠ¨å•Šï¼ç¬¬ä¸€æ¬¡æˆåŠŸï¼ğŸ‰

---

### 4.3 è®¿é—®æœåŠ¡

**åˆé‡åˆ°æ–°é—®é¢˜**ï¼šPod è·‘èµ·æ¥äº†ï¼Œæ€ä¹ˆè®¿é—®ï¼Ÿ

è¯•äº†å¥½å‡ ç§æ–¹æ³•ï¼š

#### **æ–¹æ³• 1ï¼šminikube serviceï¼ˆæ¨èï¼‰**

```bash
minikube service api-service

# è¾“å‡ºï¼š
# â—  å› ä¸ºä½ æ­£åœ¨ä½¿ç”¨ windows ä¸Šçš„ Docker é©±åŠ¨ç¨‹åºï¼Œæ‰€ä»¥éœ€è¦æ‰“å¼€ç»ˆç«¯æ‰èƒ½è¿è¡Œå®ƒã€‚
# |-----------|-------------|-------------|-------------------------|
# | NAMESPACE |    NAME     | TARGET PORT |           URL           |
# |-----------|-------------|-------------|-------------------------|
# | default   | api-service |        8080 | http://127.0.0.1:62218  |
# |-----------|-------------|-------------|-------------------------|
# ğŸ‰  æ­£é€šè¿‡é»˜è®¤æµè§ˆå™¨æ‰“å¼€æœåŠ¡ default/api-service...

# æµè§ˆå™¨è‡ªåŠ¨æ‰“å¼€ï¼Œè®¿é—®æˆåŠŸï¼âœ…
```

---

#### **æ–¹æ³• 2ï¼škubectl port-forwardï¼ˆè°ƒè¯•ç”¨ï¼‰**

```bash
kubectl port-forward svc/api-service 8080:8080

# è¾“å‡ºï¼š
# Forwarding from 127.0.0.1:8080 -> 8080

# ç„¶åè®¿é—® http://localhost:8080
```

**åŒºåˆ«**ï¼š
```
minikube service â†’ ç»è¿‡ Service è´Ÿè½½å‡è¡¡
port-forward    â†’ ç›´è¿ Podï¼ˆä¸è´Ÿè½½å‡è¡¡ï¼‰
```

---

## äº”ã€è¸©å‘å®å½•

### 5.1 ImagePullBackOffï¼ˆé•œåƒæ‰¾ä¸åˆ°ï¼‰

**å®Œæ•´æ’æŸ¥è¿‡ç¨‹**ï¼š

```bash
# 1. å‘ç°é—®é¢˜
kubectl get pods
# STATUS: ImagePullBackOff

# 2. æŸ¥çœ‹è¯¦æƒ…
kubectl describe pod api-server-xxx

# 3. çœ‹åˆ°æŠ¥é”™
# Failed to pull image "cloudnative-go-api:v0.1"

# 4. æ£€æŸ¥æœ¬åœ°é•œåƒ
docker images | grep cloudnative
# æœ¬åœ°æœ‰å•Šï¼

# 5. æ£€æŸ¥ Minikube é•œåƒ
minikube image ls | grep cloudnative
# ç©ºçš„ï¼  â† æ‰¾åˆ°é—®é¢˜äº†

# 6. è§£å†³
minikube image load cloudnative-go-api:v0.1

# 7. åˆ é™¤ Pod è®©å®ƒé‡å»º
kubectl delete pod api-server-xxx

# 8. éªŒè¯
kubectl get pods
# STATUS: Running  â† æˆåŠŸï¼
```

**æ•™è®­**ï¼šæ¯æ¬¡é‡æ–°æ„å»ºé•œåƒï¼Œéƒ½è¦é‡æ–° `minikube image load`ï¼

---

### 5.2 æ ‡ç­¾ä¸åŒ¹é…ï¼ˆService æ‰¾ä¸åˆ° Podï¼‰

**ç°è±¡**ï¼š

```bash
kubectl get svc
# NAME          TYPE       CLUSTER-IP      PORT(S)          AGE
# api-service   NodePort   10.96.123.45    8080:30080/TCP   5m

# è®¿é—®æœåŠ¡
curl http://192.168.49.2:30080/health
# curl: (7) Failed to connect  â† è¿ä¸ä¸Šï¼
```

**æ’æŸ¥**ï¼š

```bash
# æ£€æŸ¥ Endpointsï¼ˆService æ‰¾åˆ°çš„ Pod åˆ—è¡¨ï¼‰
kubectl get endpoints api-service

# NAME          ENDPOINTS
# api-service   <none>  â† ç©ºçš„ï¼Service æ²¡æ‰¾åˆ°ä»»ä½• Podï¼
```

**é—®é¢˜åœ¨å“ª**ï¼Ÿ

```bash
# æŸ¥çœ‹ Service çš„ selector
kubectl get svc api-service -o yaml | grep -A 2 selector
# selector:
#   app: api-server  â† è¿™é‡Œ

# æŸ¥çœ‹ Pod çš„ labels
kubectl get pods --show-labels
# NAME             LABELS
# api-server-xxx   app=api  â† è¿™é‡Œ

# ä¸åŒ¹é…ï¼ï¼ï¼
# Service æ‰¾ "app=api-server"
# Pod æ ‡ç­¾æ˜¯ "app=api"
# å½“ç„¶æ‰¾ä¸åˆ°ï¼
```

**æˆ‘çš„é”™è¯¯**ï¼ˆdeployment.yamlï¼‰ï¼š
```yaml
template:
  metadata:
    labels:
      app: api      # å†™æˆäº† api

# ä½† service.yaml é‡Œï¼š
selector:
  app: api-server  # å†™æˆäº† api-server
```

**ä¿®å¤**ï¼šç»Ÿä¸€æ”¹æˆ `app: api`

```bash
# é‡æ–°åº”ç”¨é…ç½®
kubectl apply -f k8s/v0.1/

# æ£€æŸ¥ Endpoints
kubectl get endpoints api-service
# NAME          ENDPOINTS
# api-service   10.244.0.5:8080,10.244.0.6:8080  â† æœ‰äº†ï¼
```

âœ… ç°åœ¨èƒ½è®¿é—®äº†ï¼

**æ•™è®­**ï¼šService selector å’Œ Pod labels å¿…é¡»**å®Œå…¨ä¸€è‡´**ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰ï¼

---

### 5.3 è´Ÿè½½å‡è¡¡çš„å¤§å‘ç° â­

è¿™æ˜¯æˆ‘è§‰å¾—æœ€æœ‰æ„æ€çš„ä¸€ä¸ªå‘ç°ã€‚

#### **é—®é¢˜æ¥äº†**

æˆ‘æƒ³éªŒè¯è´Ÿè½½å‡è¡¡ï¼Œå†™äº†ä¸ªè„šæœ¬ï¼š

```powershell
# å¯åŠ¨ port-forward
kubectl port-forward svc/api-service 8080:8080

# å¾ªç¯è¯·æ±‚ 30 æ¬¡
for ($i=1; $i -le 30; $i++) {
    $response = Invoke-RestMethod -Uri "http://localhost:8080/api/v1/info"
    Write-Host "è¯·æ±‚ $i : $($response.hostname)"
}
```

**ç»“æœ**ï¼š
```
è¯·æ±‚ 1 : api-server-xxx
è¯·æ±‚ 2 : api-server-xxx
è¯·æ±‚ 3 : api-server-xxx
...
è¯·æ±‚ 30 : api-server-xxx  â† å…¨æ˜¯åŒä¸€ä¸ª Podï¼
```

**æˆ‘çš„ç–‘é—®**ï¼šè´Ÿè½½å‡è¡¡å‘¢ï¼Ÿä¸æ˜¯æœ‰ 2 ä¸ª Pod å—ï¼Ÿ

---

#### **å¼€å§‹è°ƒæŸ¥**

```bash
# 1. æ£€æŸ¥ Pod æ•°é‡
kubectl get pods
# ç¡®å®æœ‰ 2 ä¸ª Podï¼Œéƒ½åœ¨ Running

# 2. æ£€æŸ¥ Endpoints
kubectl get endpoints api-service
# api-service   10.244.0.16:8080,10.244.0.18:8080
# 2 ä¸ª IP éƒ½åœ¨ï¼Œè¯´æ˜ 2 ä¸ª Pod éƒ½ Ready

# 3. é‚£ä¸ºä»€ä¹ˆä¸è´Ÿè½½å‡è¡¡ï¼Ÿ
```

---

#### **çœŸç›¸æ­æ™“**

Google äº†ä¸€åœˆï¼Œç»ˆäºæ˜ç™½äº†ï¼š

```
kubectl port-forward çš„å·¥ä½œåŸç†ï¼š

1. kubectl çœ‹åˆ°ä½ è¦è½¬å‘ Service
2. kubectl æŸ¥è¯¢è¿™ä¸ª Service æœ‰å“ªäº› Pod
3. kubectl éšæœºé€‰ä¸€ä¸ª Podï¼ˆæ¯”å¦‚ 26psxï¼‰
4. kubectl å’Œè¿™ä¸ª Pod å»ºç«‹ WebSocket é•¿è¿æ¥
5. ä½ çš„æ‰€æœ‰è¯·æ±‚éƒ½é€šè¿‡è¿™ä¸ªé•¿è¿æ¥è½¬å‘

æµç¨‹ï¼š
localhost:8080 
  â†’ kubectl é•¿è¿æ¥
  â†’ å›ºå®šçš„ Pod (26psx)  â† ç»•è¿‡äº† Serviceï¼

æ‰€ä»¥ï¼šport-forward ä¸ç»è¿‡ Serviceï¼Œå½“ç„¶çœ‹ä¸åˆ°è´Ÿè½½å‡è¡¡ï¼
```

---

#### **æ­£ç¡®çš„æµ‹è¯•æ–¹æ³•**

**åœ¨é›†ç¾¤å†…éƒ¨æµ‹è¯•**ï¼ˆçœŸå®çš„ä½¿ç”¨åœºæ™¯ï¼‰ï¼š

```bash
# åˆ›å»ºä¸€ä¸ªä¸´æ—¶ Pod
kubectl run test-pod --image=alpine --rm -it -- sh

# è¿›å…¥ Pod åï¼Œå®‰è£… curl
apk add curl

# æµ‹è¯•è´Ÿè½½å‡è¡¡
for i in $(seq 1 20); do
    curl -s http://api-service:8080/api/v1/info | grep hostname
    sleep 0.2
done

# é€€å‡º
exit
```

**ç»“æœ**ï¼š
```json
{"hostname":"api-server-26psx",...}  â† Pod 1
{"hostname":"api-server-nlj5w",...}  â† Pod 2  âœ… åˆ‡æ¢äº†ï¼
{"hostname":"api-server-26psx",...}  â† Pod 1  âœ… åˆåˆ‡æ¢äº†ï¼
{"hostname":"api-server-nlj5w",...}  â† Pod 2
...

ç»Ÿè®¡ï¼šPod 1 å‡ºç° 13 æ¬¡ï¼ŒPod 2 å‡ºç° 7 æ¬¡
è´Ÿè½½å‡è¡¡æ­£å¸¸ï¼âœ…
```

**ä¸ºä»€ä¹ˆé›†ç¾¤å†…èƒ½çœ‹åˆ°è´Ÿè½½å‡è¡¡**ï¼Ÿ

```
é›†ç¾¤å†…è®¿é—®æµç¨‹ï¼š
test-pod 
  â†’ curl http://api-service:8080
  â†’ DNS è§£æ â†’ 10.96.123.45ï¼ˆService IPï¼‰
  â†’ iptables è§„åˆ™åŒ¹é…
  â†’ éšæœºé€‰æ‹©ä¸€ä¸ª Pod
  â†’ è½¬å‘è¯·æ±‚ âœ…

æ¯æ¬¡ curl éƒ½æ˜¯æ–°è¿æ¥
â†’ æ¯æ¬¡éƒ½é‡æ–°è´Ÿè½½å‡è¡¡ âœ…
```

**ç½‘ç»œè·¯å¾„å¯¹æ¯”**ï¼š

```
port-forwardï¼ˆä¸è´Ÿè½½å‡è¡¡ï¼‰:
Windows â†’ kubectl éš§é“ â†’ å›ºå®š Pod

é›†ç¾¤å†…è®¿é—®ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰:
Pod â†’ Service â†’ iptables â†’ éšæœºé€‰ Pod
```

**æç„¶å¤§æ‚Ÿ**ï¼

---

## å…­ã€éªŒè¯å’Œæµ‹è¯•

### æœ€ç»ˆéªŒè¯æ¸…å•

```bash
# 1. Pod çŠ¶æ€
kubectl get pods
# 2 ä¸ª Podï¼Œéƒ½æ˜¯ Running âœ…

# 2. Service çŠ¶æ€
kubectl get svc api-service
# TYPE: NodePort âœ…

# 3. Endpoints
kubectl get endpoints api-service
# 2 ä¸ª IP:Port âœ…

# 4. æµè§ˆå™¨è®¿é—®
minikube service api-service
# æµè§ˆå™¨æ‰“å¼€ï¼Œèƒ½è®¿é—® âœ…

# 5. è´Ÿè½½å‡è¡¡ï¼ˆé›†ç¾¤å†…æµ‹è¯•ï¼‰
kubectl run test --image=alpine --rm -it -- sh
apk add curl
for i in $(seq 1 20); do curl -s http://api-service:8080/api/v1/info | grep hostname; done
# çœ‹åˆ°ä¸åŒçš„ hostname âœ…
```

å…¨éƒ¨é€šè¿‡ï¼ç¬¬ä¸€æ¬¡ K8s éƒ¨ç½²æˆåŠŸï¼ğŸŠ

---

## ç»“è¯­

ç¬¬ä¸€æ¬¡éƒ¨ç½²åˆ° Kubernetesï¼Œä»å®Œå…¨ä¸æ‡‚åˆ°æˆåŠŸè¿è¡Œï¼Œæˆ‘å­¦åˆ°äº†ï¼š

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- Pod = æœ€å°å•ä½ï¼ˆå®¹å™¨ç»„ï¼‰
- Deployment = ç®¡ç† Podï¼ˆè‡ªåŠ¨é‡å¯ã€æ›´æ–°ï¼‰
- Service = è´Ÿè½½å‡è¡¡å™¨ï¼ˆç¨³å®šå…¥å£ï¼‰

**å…³é”®æŠ€å·§**ï¼š
- é•œåƒå¿…é¡»åŠ è½½åˆ° Minikube
- selector å’Œ labels å¿…é¡»åŒ¹é…
- port-forward æ˜¯è°ƒè¯•å·¥å…·ï¼Œä¸èµ°è´Ÿè½½å‡è¡¡
- è¦æµ‹è´Ÿè½½å‡è¡¡ï¼Œåœ¨é›†ç¾¤å†…æµ‹

**è¸©è¿‡çš„å‘**ï¼š
- ImagePullBackOff â†’ `minikube image load`
- Service æ‰¾ä¸åˆ° Pod â†’ æ£€æŸ¥æ ‡ç­¾
- çœ‹ä¸åˆ°è´Ÿè½½å‡è¡¡ â†’ ç”¨å¯¹æµ‹è¯•æ–¹æ³•

**æ€ç»´è½¬å˜**ï¼š
```
Docker æ€ç»´ï¼š
- æˆ‘æ‰‹åŠ¨ run å®¹å™¨
- æˆ‘æ‰‹åŠ¨ç®¡ç†

K8s æ€ç»´ï¼š
- æˆ‘å‘Šè¯‰ K8s æˆ‘è¦ä»€ä¹ˆï¼ˆYAMLï¼‰
- K8s è‡ªåŠ¨å¸®æˆ‘å®ç°
- å£°æ˜å¼ > å‘½ä»¤å¼
```

ä¸‹ä¸€ç¯‡æˆ‘ä¼šæ·±å…¥è®²**å¥åº·æ£€æŸ¥å’Œèµ„æºé™åˆ¶**çš„é…ç½®ï¼Œè¿™ä¸¤ä¸ªçœ‹ä¼¼ç®€å•ï¼Œä½†å‘æ›´å¤šï¼

---

**æœ¬æ–‡å®Œæ•´ä»£ç **ï¼šhttps://github.com/yourname/cloudnative-go-journey

ä»Šå¤©çš„åˆ†äº«åˆ°è¿™é‡Œå°±ç»“æŸå•¦ï¼å¦‚æœè§‰å¾—æ–‡ç« è¿˜ä¸é”™çš„è¯ï¼Œæ¬¢è¿ï¼š
- â­ ç»™é¡¹ç›®ç‚¹ä¸ª Star
- ğŸ’¬ è¯„è®ºåŒºèŠèŠä½ éƒ¨ç½² K8s æ—¶é‡åˆ°çš„å‘
- ğŸ“¤ è½¬å‘ç»™æ­£åœ¨å­¦ K8s çš„æœ‹å‹

**ä½ é‡åˆ°è¿‡ ImagePullBackOff å—ï¼Ÿæ€ä¹ˆè§£å†³çš„ï¼Ÿæ¬¢è¿è¯„è®ºåŒºäº¤æµï¼**

---

**ä½œè€…**ï¼šä¸€ä¸ªè¸©å‘æ— æ•°çš„äº‘åŸç”Ÿå­¦ä¹ è€…  
**æ—¥æœŸ**ï¼š2025-10-27  
**ç³»åˆ—**ï¼šCloudNative Go Journey v0.1

ä¸Šä¸€ç¯‡ï¼š[ã€Šä»é›¶å¼€å§‹çš„äº‘åŸç”Ÿä¹‹æ—…ï¼ˆä¸€ï¼‰ï¼šæŠŠ Go åº”ç”¨å¡è¿› Dockerã€‹](01-go-containerization.md)  
ä¸‹ä¸€ç¯‡ï¼š[ã€Šä»é›¶å¼€å§‹çš„äº‘åŸç”Ÿä¹‹æ—…ï¼ˆä¸‰ï¼‰ï¼šå¥åº·æ£€æŸ¥å·®ç‚¹æŠŠæˆ‘å‘æ­»ã€‹](03-health-checks-and-resources.md)
