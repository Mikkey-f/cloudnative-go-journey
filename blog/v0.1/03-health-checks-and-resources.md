# ä»é›¶å¼€å§‹çš„äº‘åŸç”Ÿä¹‹æ—…ï¼ˆä¸‰ï¼‰ï¼šå¥åº·æ£€æŸ¥å·®ç‚¹æŠŠæˆ‘å‘æ­»

> Pod ä¸ºä»€ä¹ˆç–¯ç‹‚é‡å¯ï¼Ÿèµ„æºé™åˆ¶æ€ä¹ˆè®¾ç½®ï¼Ÿç”Ÿäº§ç¯å¢ƒçš„è¡€æ³ªæ•™è®­

## æ–‡ç« ç›®å½•

- å‰è¨€
- ä¸€ã€å¥åº·æ£€æŸ¥ï¼šæˆ‘è¸©è¿‡çš„å‘
  - 1.1 ä»€ä¹ˆæ˜¯å¥åº·æ£€æŸ¥ï¼Ÿ
  - 1.2 Liveness vs Readinessï¼ˆå‚»å‚»åˆ†ä¸æ¸…æ¥šï¼‰
  - 1.3 ç¬¬ä¸€æ¬¡é…ç½®ï¼ˆPod ç–¯ç‹‚é‡å¯ï¼‰
  - 1.4 å‚æ•°è°ƒä¼˜è¿‡ç¨‹
- äºŒã€èµ„æºé™åˆ¶ï¼šä¸€ä¸ª Pod åƒå…‰æ‰€æœ‰å†…å­˜
  - 2.1 ä¸ºä»€ä¹ˆéœ€è¦èµ„æºé™åˆ¶ï¼Ÿ
  - 2.2 Requests vs Limitsï¼ˆæœ‰å•¥åŒºåˆ«ï¼Ÿï¼‰
  - 2.3 æ€ä¹ˆè®¾ç½®åˆç†çš„å€¼ï¼Ÿ
  - 2.4 æˆ‘è¸©è¿‡çš„å‘
- ä¸‰ã€ç”Ÿäº§çº§é…ç½®æ¨è
  - 3.1 å¥åº·æ£€æŸ¥æœ€ä½³å®è·µ
  - 3.2 èµ„æºé™åˆ¶å‚è€ƒå€¼
  - 3.3 è°ƒè¯•æŠ€å·§
- å››ã€å®æˆ˜éªŒè¯
  - 4.1 æ¨¡æ‹Ÿ Pod æ•…éšœ
  - 4.2 è§‚å¯Ÿè‡ªåŠ¨æ¢å¤
- ç»“è¯­

---

## å‰è¨€

ä¸Šä¸€ç¯‡æŠŠæœåŠ¡éƒ¨ç½²åˆ° K8s åï¼Œæˆ‘ä»¥ä¸ºå¤§åŠŸå‘Šæˆäº†ã€‚

**ç»“æœç¬¬äºŒå¤©**ï¼š

```bash
kubectl get pods

# NAME                READY   STATUS             RESTARTS   AGE
# api-server-xxx      0/1     CrashLoopBackOff   17         10m
#                             â†‘ è¿™æ˜¯å•¥ï¼Ÿ        â†‘ é‡å¯ 17 æ¬¡ï¼
```

**CrashLoopBackOff** = å®¹å™¨ä¸æ–­å´©æºƒ â†’ é‡å¯ â†’ å´©æºƒ â†’ é‡å¯...

æˆ‘äººå‚»äº†ï¼šå¥½å¥½çš„æœåŠ¡æ€ä¹ˆç–¯ç‹‚é‡å¯ï¼Ÿ

è¿™ç¯‡æ–‡ç« è®°å½•æˆ‘**æ’æŸ¥é—®é¢˜çš„å®Œæ•´è¿‡ç¨‹**ï¼Œä»¥åŠå­¦åˆ°çš„**å¥åº·æ£€æŸ¥å’Œèµ„æºé™åˆ¶**çš„çŸ¥è¯†ã€‚

---

## ä¸€ã€å¥åº·æ£€æŸ¥ï¼šæˆ‘è¸©è¿‡çš„å‘

### 1.1 ä»€ä¹ˆæ˜¯å¥åº·æ£€æŸ¥ï¼Ÿ

**æŸ¥èµ„æ–™åæ‰çŸ¥é“**ï¼š

```
å¥åº·æ£€æŸ¥ = Kubernetes çš„"å¿ƒè·³æ£€æµ‹"

K8s ä¼šå®šæœŸé—®ä½ çš„å®¹å™¨ï¼š
- "ä½ è¿˜æ´»ç€å—ï¼Ÿ"ï¼ˆLiveness Probeï¼‰
- "ä½ å‡†å¤‡å¥½æ¥æ”¶æµé‡äº†å—ï¼Ÿ"ï¼ˆReadiness Probeï¼‰

å¦‚æœä½ ä¸å›ç­”ï¼Œæˆ–è€…å›ç­”æ…¢äº†ï¼š
â†’ K8s è®¤ä¸ºä½ æœ‰é—®é¢˜
â†’ é‡‡å–è¡ŒåŠ¨ï¼ˆé‡å¯æˆ–æ‘˜é™¤ï¼‰
```

**ç±»æ¯”**ï¼š
```
å¥åº·æ£€æŸ¥ = å…¬å¸è€ƒå‹¤æ‰“å¡

Livenessï¼ˆå­˜æ´»ï¼‰: 
  - æ¯å¤©æ‰“å¡è¯æ˜ä½ è¿˜æ´»ç€
  - ä¸æ‰“å¡ â†’ å…¬å¸è®¤ä¸ºä½ æ—·å·¥ â†’ å¼€é™¤ï¼ˆé‡å¯å®¹å™¨ï¼‰

Readinessï¼ˆå°±ç»ªï¼‰:
  - æ‰“å¡åè¿˜è¦ç­¾åˆ°"æˆ‘å‡†å¤‡å¥½å·¥ä½œäº†"
  - æ²¡ç­¾åˆ° â†’ æš‚æ—¶ä¸ç»™ä½ åˆ†é…å·¥ä½œï¼ˆä¸å‘é€æµé‡ï¼‰
  - å‡†å¤‡å¥½äº†å†ç­¾åˆ° â†’ å¼€å§‹åˆ†é…å·¥ä½œ
```

---

### 1.2 Liveness vs Readinessï¼ˆå‚»å‚»åˆ†ä¸æ¸…æ¥šï¼‰

æˆ‘ä¸€å¼€å§‹åˆ†ä¸æ¸…è¿™ä¸¤ä¸ªï¼Œåæ¥é‡åˆ°äº†è¿™ä¸ªåœºæ™¯æ‰æç„¶å¤§æ‚Ÿï¼š

#### **åœºæ™¯ï¼šåº”ç”¨å¯åŠ¨æ…¢**

æˆ‘çš„ Go åº”ç”¨å¯åŠ¨æµç¨‹ï¼š

```
t=0s   å®¹å™¨å¯åŠ¨
t=2s   Go ç¨‹åºå¼€å§‹è¿è¡Œ
t=5s   è¿æ¥æ•°æ®åº“ä¸­...
t=8s   æ•°æ®åº“è¿æ¥æˆåŠŸ
t=10s  åº”ç”¨å®Œå…¨å°±ç»ª
```

**å¦‚æœæˆ‘è¿™æ ·é…ç½®**ï¼ˆé”™è¯¯ï¼‰ï¼š

```yaml
livenessProbe:
  httpGet:
    path: /health
  initialDelaySeconds: 5  # 5 ç§’åå¼€å§‹æ£€æŸ¥
```

**ä¼šå‘ç”Ÿä»€ä¹ˆ**ï¼Ÿ

```
t=5s  K8s ç¬¬ä¸€æ¬¡æ£€æŸ¥ /health
      â†’ åº”ç”¨è¿˜åœ¨è¿æ•°æ®åº“
      â†’ è¿”å› 503 æˆ–è¶…æ—¶
      â†’ Liveness å¤±è´¥
      
t=5s  K8s: "å®¹å™¨æŒ‚äº†ï¼Œé‡å¯ï¼"
      â†’ Pod é‡å¯
      
t=0s  åˆä»å¤´å¼€å§‹...
t=5s  åˆæ£€æŸ¥ /health
      â†’ åˆå¤±è´¥
      â†’ åˆé‡å¯

æ— é™å¾ªç¯ï¼ï¼ï¼
```

**æ­£ç¡®çš„åšæ³•**ï¼š

```yaml
# Liveness: æ£€æŸ¥è¿›ç¨‹æ˜¯å¦æ´»ç€ï¼ˆå®½æ¾ä¸€ç‚¹ï¼‰
livenessProbe:
  httpGet:
    path: /health
  initialDelaySeconds: 15  # 15 ç§’ï¼ˆå¤§äºå¯åŠ¨æ—¶é—´ï¼‰
  failureThreshold: 3      # å¤±è´¥ 3 æ¬¡æ‰é‡å¯

# Readiness: æ£€æŸ¥æ˜¯å¦å‡†å¤‡å¥½ï¼ˆå¯ä»¥ä¸¥æ ¼ä¸€ç‚¹ï¼‰
readinessProbe:
  httpGet:
    path: /ready
  initialDelaySeconds: 5   # 5 ç§’å°±å¯ä»¥å¼€å§‹æ£€æŸ¥
  failureThreshold: 3      # å¤±è´¥äº†å°±ä¸å‘æµé‡ï¼Œä½†ä¸é‡å¯
```

**æ•ˆæœ**ï¼š

```
t=5s   Readiness æ£€æŸ¥ /ready
       â†’ è¿˜æ²¡å‡†å¤‡å¥½ â†’ è¿”å› 503
       â†’ K8s: "å¥½çš„ï¼Œæˆ‘å…ˆä¸å‘æµé‡ç»™ä½ "  âœ…

t=10s  Readiness å†æ¬¡æ£€æŸ¥
       â†’ å‡†å¤‡å¥½äº† â†’ è¿”å› 200
       â†’ K8s: "å¯ä»¥å‘æµé‡äº†"  âœ…

t=15s  Liveness ç¬¬ä¸€æ¬¡æ£€æŸ¥
       â†’ åº”ç”¨å·²ç»å¯åŠ¨å¥½äº† â†’ è¿”å› 200  âœ…

ä¸ä¼šé‡å¯ï¼å®Œç¾ï¼
```

**æ€»ç»“**ï¼š
```
Livenessï¼ˆå­˜æ´»ï¼‰:
  - æ£€æŸ¥ï¼šè¿›ç¨‹æ˜¯å¦è¿˜æ´»ç€
  - å¤±è´¥ â†’ é‡å¯å®¹å™¨
  - åœºæ™¯ï¼šåº”ç”¨æ­»é”ã€å†…å­˜æ³„æ¼

Readinessï¼ˆå°±ç»ªï¼‰:
  - æ£€æŸ¥ï¼šæ˜¯å¦å‡†å¤‡å¥½æ¥æ”¶æµé‡
  - å¤±è´¥ â†’ ä» Service æ‘˜é™¤ï¼ˆä¸é‡å¯ï¼‰
  - åœºæ™¯ï¼šå¯åŠ¨ä¸­ã€ä¸´æ—¶è¿‡è½½
```

---

### 1.3 ç¬¬ä¸€æ¬¡é…ç½®ï¼ˆPod ç–¯ç‹‚é‡å¯ï¼‰

å›åˆ°æˆ‘çš„é—®é¢˜ï¼šä¸ºä»€ä¹ˆ Pod é‡å¯ 17 æ¬¡ï¼Ÿ

**æŸ¥æ—¥å¿—**ï¼š

```bash
kubectl logs api-server-xxx --previous  # çœ‹ä¸Šä¸€æ¬¡å®¹å™¨çš„æ—¥å¿—

# è¾“å‡ºï¼š
# ğŸš€ Server starting on :8080...
# [ç„¶åå°±æ²¡äº†]

kubectl describe pod api-server-xxx

# Events:
#   Warning  Unhealthy  Liveness probe failed: Get "http://10.244.0.5:8080/health": 
#                        context deadline exceeded (Client.Timeout exceeded)
```

**é—®é¢˜æ‰¾åˆ°äº†**ï¼šå¥åº·æ£€æŸ¥è¶…æ—¶ï¼

**æˆ‘çš„é…ç½®**ï¼ˆç¬¬ä¸€ç‰ˆï¼Œæœ‰é—®é¢˜ï¼‰ï¼š

```yaml
livenessProbe:
  httpGet:
    path: /health
    port: 8080
  initialDelaySeconds: 5   # åªç­‰ 5 ç§’
  timeoutSeconds: 1        # 1 ç§’è¶…æ—¶
  failureThreshold: 1      # å¤±è´¥ 1 æ¬¡å°±é‡å¯
```

**ä¸ºä»€ä¹ˆå¤±è´¥**ï¼Ÿ
```
æˆ‘çš„åº”ç”¨å¯åŠ¨éœ€è¦ 8 ç§’ï¼ˆåŠ è½½é…ç½®ã€è¿æ¥ç­‰ï¼‰
ä½† K8s 5 ç§’å°±å¼€å§‹æ£€æŸ¥äº†
â†’ åº”ç”¨è¿˜æ²¡èµ·æ¥
â†’ æ£€æŸ¥è¶…æ—¶
â†’ 1 æ¬¡å¤±è´¥å°±é‡å¯
â†’ åˆä»å¤´å¼€å§‹
â†’ 5 ç§’ååˆæ£€æŸ¥
â†’ åˆå¤±è´¥
â†’ åˆé‡å¯...

æ­»å¾ªç¯ï¼
```

---

### 1.4 å‚æ•°è°ƒä¼˜è¿‡ç¨‹

**è°ƒä¼˜è¿‡ç¨‹**ï¼ˆè¯•äº† 3 æ¬¡ï¼‰ï¼š

#### **ç¬¬ 2 ç‰ˆ**ï¼ˆè¿˜æ˜¯ä¸è¡Œï¼‰ï¼š

```yaml
livenessProbe:
  initialDelaySeconds: 8  # æ”¹æˆ 8 ç§’
  timeoutSeconds: 2
  failureThreshold: 2
```

**ç»“æœ**ï¼šå¶å°”è¿˜æ˜¯ä¼šé‡å¯ï¼ˆç½‘ç»œæŠ–åŠ¨çš„æ—¶å€™ï¼‰

---

#### **ç¬¬ 3 ç‰ˆ**ï¼ˆç»ˆäºç¨³å®šäº†ï¼‰ï¼š

```yaml
livenessProbe:
  httpGet:
    path: /health
    port: 8080
  initialDelaySeconds: 10  # å®å¯å¤šç­‰ä¸€ä¼š
  periodSeconds: 10        # æ¯ 10 ç§’æ£€æŸ¥ï¼ˆä¸ç”¨å¤ªé¢‘ç¹ï¼‰
  timeoutSeconds: 3        # 3 ç§’è¶…æ—¶ï¼ˆç½‘ç»œæŠ–åŠ¨ä¹Ÿèƒ½å®¹å¿ï¼‰
  failureThreshold: 3      # è¿ç»­å¤±è´¥ 3 æ¬¡æ‰é‡å¯

readinessProbe:
  httpGet:
    path: /ready
    port: 8080
  initialDelaySeconds: 5
  periodSeconds: 5         # å¯ä»¥é¢‘ç¹ä¸€ç‚¹
  timeoutSeconds: 2
  failureThreshold: 3
```

**é‡æ–°éƒ¨ç½²**ï¼š

```bash
kubectl apply -f k8s/v0.1/deployment.yaml
kubectl get pods -w  # å®æ—¶è§‚å¯Ÿ

# NAME                READY   STATUS    RESTARTS   AGE
# api-server-xxx      0/1     Running   0          5s
# api-server-xxx      1/1     Running   0          15s  â† ç¨³å®šäº†ï¼
```

**æ•™è®­**ï¼š
```
å®å¯å‚æ•°å®½æ¾ï¼Œä¸è¦å¤ªä¸¥æ ¼ï¼
- initialDelaySeconds è¦å¤§äºå®é™…å¯åŠ¨æ—¶é—´
- timeoutSeconds è‡³å°‘ 3 ç§’
- failureThreshold è‡³å°‘ 3 æ¬¡
```

---

## äºŒã€èµ„æºé™åˆ¶ï¼šä¸€ä¸ª Pod åƒå…‰æ‰€æœ‰å†…å­˜

### 2.1 ä¸ºä»€ä¹ˆéœ€è¦èµ„æºé™åˆ¶ï¼Ÿ

**çœŸå®çš„æ•™è®­**ï¼ˆæœ‹å‹çš„ç”Ÿäº§äº‹æ•…ï¼‰ï¼š

```
åœºæ™¯ï¼šæŸä¸ª Pod æœ‰å†…å­˜æ³„æ¼

æ²¡æœ‰èµ„æºé™åˆ¶ï¼š
- è¿™ä¸ª Pod è¶Šåƒè¶Šå¤šå†…å­˜
- 5 åˆ†é’Ÿååƒåˆ° 8GBï¼ˆèŠ‚ç‚¹åªæœ‰ 8GBï¼‰
- å…¶ä»– Pod å…¨éƒ¨ OOMKilled
- æ•´ä¸ªèŠ‚ç‚¹å´©æºƒ  âŒ

æœ‰èµ„æºé™åˆ¶ï¼š
- Pod è¾¾åˆ° 128MB é™åˆ¶
- K8s åªæ€æ­»è¿™ä¸€ä¸ª Pod
- å…¶ä»– Pod æ­£å¸¸è¿è¡Œ
- é—®é¢˜éš”ç¦»  âœ…
```

**ç»“è®º**ï¼šèµ„æºé™åˆ¶ = ä¿æŠ¤æ•´ä¸ªé›†ç¾¤ï¼

---

### 2.2 Requests vs Limitsï¼ˆæœ‰å•¥åŒºåˆ«ï¼Ÿï¼‰

é…ç½®æ–‡ä»¶é‡Œæœ‰ä¸¤ä¸ªä¸œè¥¿ï¼Œæˆ‘ä¸€å¼€å§‹æä¸æ‡‚ï¼š

```yaml
resources:
  requests:    # è¿™æ˜¯å•¥ï¼Ÿ
    memory: "64Mi"
    cpu: "100m"
  limits:      # è¿™åˆæ˜¯å•¥ï¼Ÿ
    memory: "128Mi"
    cpu: "200m"
```

**æŸ¥èµ„æ–™åç†è§£äº†**ï¼š

#### **Requestsï¼ˆè¯·æ±‚ï¼‰= ä¿åº•èµ„æº**

```
å«ä¹‰ï¼šK8s è°ƒåº¦æ—¶ä¿è¯ç»™ä½ è¿™ä¹ˆå¤šèµ„æº

åœºæ™¯ï¼š
èŠ‚ç‚¹ A æœ‰ 4GB å†…å­˜

Pod 1: requests.memory = 1GB  âœ… è°ƒåº¦åˆ°èŠ‚ç‚¹ A
Pod 2: requests.memory = 2GB  âœ… è°ƒåº¦åˆ°èŠ‚ç‚¹ A
Pod 3: requests.memory = 1.5GB  âŒ è¶…äº†ï¼è°ƒåº¦åˆ°èŠ‚ç‚¹ B

æ€»è®¡ï¼š1+2+1.5 = 4.5GB > 4GB

K8s: "èŠ‚ç‚¹ A èµ„æºä¸å¤Ÿäº†ï¼ŒPod 3 å»èŠ‚ç‚¹ B"
```

**å›¾ç¤º**ï¼š
```
èŠ‚ç‚¹ A (4GB å†…å­˜)
â”œâ”€â”€ Pod 1: requests 1GB  â† å ç”¨ä¿åº• 1GB
â”œâ”€â”€ Pod 2: requests 2GB  â† å ç”¨ä¿åº• 2GB
â””â”€â”€ Pod 3: requests 1.5GB âŒ æ”¾ä¸ä¸‹äº†ï¼

â†’ Pod 3 ä¼š Pendingï¼ˆç­‰å¾…æœ‰èµ„æºçš„èŠ‚ç‚¹ï¼‰
```

---

#### **Limitsï¼ˆé™åˆ¶ï¼‰= æœ€å¤§èµ„æº**

```
å«ä¹‰ï¼šPod æœ€å¤šèƒ½ç”¨è¿™ä¹ˆå¤š

CPU Limitï¼š
- è¶…è¿‡é™åˆ¶ â†’ CPU é™æµï¼ˆthrottleï¼‰
- è¿›ç¨‹å˜æ…¢ï¼Œä½†ä¸ä¼šè¢«æ€

Memory Limitï¼š
- è¶…è¿‡é™åˆ¶ â†’ è¢«æ€æ­»ï¼ˆOOMKilledï¼‰
- Pod é‡å¯

ç¤ºä¾‹ï¼š
Pod é™åˆ¶ 128Mi å†…å­˜
å®é™…ç”¨äº† 150Mi
â†’ K8s: "ä½ è¶…äº†ï¼Œæ€ï¼"
â†’ Pod è¢« killï¼ŒçŠ¶æ€å˜æˆ OOMKilled
```

**ç®€å•è®°å¿†**ï¼š
```
Requests = æœ€å°‘ç»™æˆ‘è¿™ä¹ˆå¤šï¼ˆè°ƒåº¦ä¾æ®ï¼‰
Limits   = æœ€å¤šè®©æˆ‘ç”¨è¿™ä¹ˆå¤šï¼ˆç¡¬é™åˆ¶ï¼‰
```

---

### 2.3 æ€ä¹ˆè®¾ç½®åˆç†çš„å€¼ï¼Ÿ

**æˆ‘çš„æ–¹æ³•**ï¼ˆå…ˆè·‘èµ·æ¥ï¼Œå†è§‚å¯Ÿï¼‰ï¼š

```bash
# 1. å…ˆä¸è®¾èµ„æºé™åˆ¶ï¼Œéƒ¨ç½²
kubectl apply -f deployment.yaml

# 2. å¯ç”¨ç›‘æ§
minikube addons enable metrics-server

# 3. ç­‰ 1-2 åˆ†é’Ÿï¼ŒæŸ¥çœ‹å®é™…ä½¿ç”¨
kubectl top pods

# è¾“å‡ºï¼š
# NAME                CPU(cores)   MEMORY(bytes)
# api-server-xxx      52m          48Mi
# api-server-yyy      51m          47Mi

# å®é™…ä½¿ç”¨ï¼šCPU 50mï¼Œå†…å­˜ 48Mi
```

**è®¾ç½®ç­–ç•¥**ï¼š
```
requests = å®é™…ä½¿ç”¨ * 1.5-2
limits   = requests * 2-3

æˆ‘çš„é…ç½®ï¼š
requests:
  cpu: 100m      # 50m * 2
  memory: 64Mi   # 48Mi * 1.5
limits:
  cpu: 200m      # 100m * 2
  memory: 128Mi  # 64Mi * 2
```

---

### 2.4 æˆ‘è¸©è¿‡çš„å‘

#### å‘ 1ï¼šå†…å­˜é™åˆ¶è®¾å¤ªå°

**æˆ‘çš„é”™è¯¯å°è¯•**ï¼š

```yaml
resources:
  limits:
    memory: "32Mi"  # æƒ³ç€èŠ‚çœèµ„æº
```

**ç»“æœ**ï¼š

```bash
kubectl get pods
# NAME                READY   STATUS      RESTARTS   AGE
# api-server-xxx      0/1     OOMKilled   5          2m

kubectl describe pod api-server-xxx
# Last State:     Terminated
#   Reason:       OOMKilled
#   Exit Code:    137  â† 137 = è¢« OOM æ€æ­»
```

**é—®é¢˜**ï¼šGo ç¨‹åºå¯åŠ¨å°±éœ€è¦ 40-50Mi å†…å­˜ï¼Œ32Mi æ ¹æœ¬ä¸å¤Ÿï¼

**æ•™è®­**ï¼šä¸è¦ä¸ºäº†"èŠ‚çœ"è®¾å¤ªå°çš„é™åˆ¶ï¼Œå…ˆè§‚å¯Ÿå®é™…ä½¿ç”¨ï¼

---

#### å‘ 2ï¼šåªè®¾ Limits ä¸è®¾ Requests

**æˆ‘çš„é”™è¯¯**ï¼š

```yaml
resources:
  limits:
    memory: "128Mi"
  # æ²¡å†™ requests
```

**ç»“æœ**ï¼šK8s è‡ªåŠ¨è®¾ç½® `requests = limits`
```
ç›¸å½“äºï¼š
requests.memory: 128Mi
limits.memory:   128Mi

é—®é¢˜ï¼š
- èŠ‚ç‚¹æœ‰ 4GB å†…å­˜
- ä½†åªèƒ½è°ƒåº¦ 4GB / 128Mi = 31 ä¸ª Pod
- å®é™…ä¸Šæ¯ä¸ª Pod åªç”¨ 50Mi
- æµªè´¹äº†ä¸€åŠèµ„æºï¼
```

**æ•™è®­**ï¼šrequests å’Œ limits éƒ½è¦è®¾ï¼Œè€Œä¸” `requests < limits`ï¼

---

#### å‘ 3ï¼šå¥åº·æ£€æŸ¥ç­‰å¾…æ—¶é—´å¤ªçŸ­

**æˆ‘çš„ç¬¬ä¸€ç‰ˆ**ï¼ˆå¯¼è‡´ç–¯ç‹‚é‡å¯ï¼‰ï¼š

```yaml
livenessProbe:
  httpGet:
    path: /health
    port: 8080
  initialDelaySeconds: 5   # å¤ªçŸ­äº†ï¼
  periodSeconds: 5
  timeoutSeconds: 1        # 1 ç§’è¶…æ—¶å¤ªä¸¥æ ¼
  failureThreshold: 1      # å¤±è´¥ 1 æ¬¡å°±é‡å¯
```

**é—®é¢˜**ï¼š
```
åº”ç”¨å¯åŠ¨éœ€è¦ 8 ç§’
ä½† 5 ç§’å°±å¼€å§‹æ£€æŸ¥
â†’ åº”ç”¨è¿˜æ²¡èµ·æ¥
â†’ æ£€æŸ¥å¤±è´¥
â†’ 1 æ¬¡å¤±è´¥å°±é‡å¯
â†’ åˆé‡å¯ï¼Œåˆå¤±è´¥ï¼Œåˆé‡å¯...

RESTARTS: 17  â† å°±æ˜¯è¿™ä¹ˆæ¥çš„ï¼
```

**ä¿®å¤å**ï¼š

```yaml
livenessProbe:
  initialDelaySeconds: 10  # æ”¹æˆ 10 ç§’
  timeoutSeconds: 3        # 3 ç§’è¶…æ—¶
  failureThreshold: 3      # 3 æ¬¡å¤±è´¥æ‰é‡å¯
```

**é‡æ–°éƒ¨ç½²**ï¼š

```bash
kubectl apply -f deployment.yaml
kubectl get pods -w

# api-server-xxx      0/1     Running   0          5s
# api-server-xxx      1/1     Running   0          15s  â† ç¨³å®šäº†ï¼ä¸å†é‡å¯ï¼
```

**ç»ˆäºä¸é‡å¯äº†**ï¼ğŸ’¯

---

## ä¸‰ã€ç”Ÿäº§çº§é…ç½®æ¨è

ç»è¿‡æ— æ•°æ¬¡è°ƒè¯•ï¼Œæˆ‘æ€»ç»“äº†ä¸€å¥—é…ç½®ï¼š

### 3.1 å¥åº·æ£€æŸ¥æœ€ä½³å®è·µ

```yaml
containers:
- name: api
  image: cloudnative-go-api:v0.1
  
  # Liveness - å®½æ¾é…ç½®
  livenessProbe:
    httpGet:
      path: /health
      port: 8080
    initialDelaySeconds: 10   # æ ¹æ®åº”ç”¨å®é™…å¯åŠ¨æ—¶é—´
    periodSeconds: 10         # 10 ç§’æ£€æŸ¥ä¸€æ¬¡å¤Ÿäº†
    timeoutSeconds: 3         # 3 ç§’è¶…æ—¶
    failureThreshold: 3       # è¿ç»­å¤±è´¥ 3 æ¬¡
  
  # Readiness - å¯ä»¥ä¸¥æ ¼ä¸€ç‚¹
  readinessProbe:
    httpGet:
      path: /ready
      port: 8080
    initialDelaySeconds: 5
    periodSeconds: 5          # æ›´é¢‘ç¹æ£€æŸ¥å°±ç»ªçŠ¶æ€
    timeoutSeconds: 2
    failureThreshold: 3
```

**å‚æ•°å«ä¹‰**ï¼š
```
initialDelaySeconds: å®¹å™¨å¯åŠ¨åç­‰å¤šä¹…å¼€å§‹æ£€æŸ¥
periodSeconds:       å¤šä¹…æ£€æŸ¥ä¸€æ¬¡
timeoutSeconds:      å¤šä¹…æ²¡å“åº”ç®—è¶…æ—¶
failureThreshold:    è¿ç»­å¤±è´¥å‡ æ¬¡æ‰ç®—å¤±è´¥
```

---

### 3.2 èµ„æºé™åˆ¶å‚è€ƒå€¼

**ä¸åŒç±»å‹åº”ç”¨çš„æ¨èé…ç½®**ï¼š

| åº”ç”¨ç±»å‹ | CPU Requests | CPU Limits | Memory Requests | Memory Limits |
|---------|-------------|-----------|----------------|--------------|
| **ç®€å• API**ï¼ˆæˆ‘çš„ï¼‰ | 100m | 200m | 64Mi | 128Mi |
| **è®¡ç®—å¯†é›†**ï¼ˆå›¾åƒå¤„ç†ï¼‰ | 500m | 1000m | 128Mi | 256Mi |
| **å†…å­˜å¯†é›†**ï¼ˆç¼“å­˜ï¼‰ | 100m | 200m | 256Mi | 512Mi |

**å•ä½è¯´æ˜**ï¼š
```
CPU:
1     = 1 æ ¸
500m  = 0.5 æ ¸
100m  = 0.1 æ ¸

å†…å­˜:
128Mi = 128 MiB = 134,217,728 å­—èŠ‚
1Gi   = 1 GiB = 1,073,741,824 å­—èŠ‚
```

---

### 3.3 è°ƒè¯•æŠ€å·§

#### **æŠ€å·§ 1ï¼šæŸ¥çœ‹å¥åº·æ£€æŸ¥çŠ¶æ€**

```bash
kubectl describe pod <pod-name> | grep -A 5 Liveness
kubectl describe pod <pod-name> | grep -A 5 Readiness

# çœ‹æ˜¯å¦æœ‰ "Unhealthy" æˆ– "failed"
```

---

#### **æŠ€å·§ 2ï¼šæ‰‹åŠ¨æµ‹è¯•å¥åº·æ£€æŸ¥ç«¯ç‚¹**

```bash
# æ–¹æ³• 1ï¼šport-forward
kubectl port-forward pod/<pod-name> 8080:8080
curl http://localhost:8080/health
curl http://localhost:8080/ready

# æ–¹æ³• 2ï¼šåœ¨ Pod å†…æµ‹è¯•
kubectl exec -it <pod-name> -- sh
wget -O- http://localhost:8080/health
```

---

#### **æŠ€å·§ 3ï¼šæŸ¥çœ‹èµ„æºä½¿ç”¨**

```bash
# å®æ—¶æŸ¥çœ‹
kubectl top pods

# è¾“å‡ºï¼š
# NAME                CPU(cores)   MEMORY(bytes)
# api-server-xxx      52m          48Mi

# å¦‚æœ CPU æˆ–å†…å­˜æ¥è¿‘ limitsï¼Œè¯´æ˜éœ€è¦è°ƒæ•´
```

---

## å››ã€å®æˆ˜éªŒè¯

### 4.1 æ¨¡æ‹Ÿ Pod æ•…éšœ

```bash
# æ‰‹åŠ¨åˆ é™¤ä¸€ä¸ª Pod
kubectl delete pod api-server-xxx

# å®æ—¶è§‚å¯Ÿ
kubectl get pods -w

# è¾“å‡ºï¼š
# api-server-xxx      1/1     Terminating   0          5m   â† æ­£åœ¨ç»ˆæ­¢
# api-server-zzz      0/1     Pending       0          0s   â† æ–° Pod åˆ›å»º
# api-server-zzz      0/1     ContainerCreating  0     2s
# api-server-zzz      1/1     Running            0     10s  â† è‡ªåŠ¨æ¢å¤ï¼
```

**æ­¤æ—¶æœåŠ¡ä¾ç„¶å¯ä»¥è®¿é—®**ï¼ˆå› ä¸ºè¿˜æœ‰å¦ä¸€ä¸ª Podï¼‰ï¼š

```bash
# æµ‹è¯•
curl http://localhost:8080/health
# æ­£å¸¸è¿”å›  âœ…

# è¯´æ˜ï¼šå•ä¸ª Pod æ•…éšœä¸å½±å“æœåŠ¡ï¼
```

---

### 4.2 è§‚å¯Ÿè‡ªåŠ¨æ¢å¤

**æ¨¡æ‹Ÿåº”ç”¨å´©æºƒ**ï¼ˆåœ¨ Pod å†…æ€æ­»è¿›ç¨‹ï¼‰ï¼š

```bash
# è¿›å…¥ Pod
kubectl exec -it api-server-xxx -- sh

# æ€æ­»è¿›ç¨‹
kill 1  # PID 1 æ˜¯ä¸»è¿›ç¨‹

# é€€å‡º Pod
exit

# è§‚å¯Ÿ
kubectl get pods

# NAME                READY   STATUS    RESTARTS   AGE
# api-server-xxx      1/1     Running   1          5m
#                                       â†‘ RESTARTS åŠ  1ï¼Œè‡ªåŠ¨é‡å¯äº†ï¼
```

**K8s æ£€æµ‹åˆ°è¿›ç¨‹é€€å‡º â†’ Liveness å¤±è´¥ â†’ è‡ªåŠ¨é‡å¯ âœ…**

---

## ç»“è¯­

ç»è¿‡è¿™è½®æŠ˜è…¾ï¼Œæˆ‘æ·±åˆ»ç†è§£äº†ï¼š

**å¥åº·æ£€æŸ¥**ï¼š
- Liveness å’Œ Readiness ä¸ä¸€æ ·ï¼Œåˆ«ææ··
- å‚æ•°å®å¯å®½æ¾ï¼Œä¸è¦å¤ªä¸¥æ ¼
- initialDelaySeconds è¦å¤§äºå¯åŠ¨æ—¶é—´
- failureThreshold è‡³å°‘ 3

**èµ„æºé™åˆ¶**ï¼š
- å¿…é¡»è®¾ç½®ï¼ˆä¿æŠ¤é›†ç¾¤ï¼‰
- å…ˆè§‚å¯Ÿå®é™…ä½¿ç”¨ï¼Œå†è®¾ç½®
- requests < limits
- ä¸è¦è®¾å¤ªå°ï¼ˆä¼š OOMKilledï¼‰

**è°ƒè¯•æŠ€å·§**ï¼š
- kubectl describe çœ‹ Events
- kubectl logs çœ‹æ—¥å¿—
- kubectl logs --previous çœ‹ä¸Šä¸€æ¬¡çš„æ—¥å¿—
- kubectl top çœ‹èµ„æºä½¿ç”¨

**æ€ç»´è½¬å˜**ï¼š
```
Docker æ€ç»´ï¼š
- æˆ‘çš„å®¹å™¨ï¼Œæˆ‘è¯´äº†ç®—

K8s æ€ç»´ï¼š
- å¤šç§Ÿæˆ·ç¯å¢ƒï¼Œè¦è€ƒè™‘ä»–äºº
- èµ„æºé™åˆ¶æ˜¯å¿…é¡»çš„
- å¥åº·æ£€æŸ¥æ˜¯å¿…é¡»çš„
- åº”ç”¨è¦æœ‰è‡ªæ„ˆèƒ½åŠ›
```

è‡³æ­¤ï¼Œv0.1 åŸºç¡€ç‰ˆå…¨éƒ¨å®Œæˆï¼ä» Go ä»£ç åˆ° Docker é•œåƒï¼Œå†åˆ° K8s éƒ¨ç½²ï¼Œå®Œæ•´çš„äº‘åŸç”Ÿä¹‹æ—…ç¬¬ä¸€ç«™åœ†æ»¡ç»“æŸã€‚

ä¸‹ä¸€æ­¥æˆ‘ä¼šå­¦ä¹ ï¼š
- v0.2ï¼šStatefulSetï¼ˆæœ‰çŠ¶æ€åº”ç”¨ï¼‰
- DaemonSetï¼ˆæ¯ä¸ªèŠ‚ç‚¹ä¸€ä¸ªï¼‰
- ConfigMapï¼ˆé…ç½®ç®¡ç†ï¼‰

æ•¬è¯·æœŸå¾…ï¼

---

**æœ¬æ–‡å®Œæ•´ä»£ç **ï¼šhttps://github.com/yourname/cloudnative-go-journey

ä»Šå¤©çš„åˆ†äº«åˆ°è¿™é‡Œå°±ç»“æŸå•¦ï¼å¦‚æœè§‰å¾—æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼Œå¯ä»¥ï¼š
- â­ ç»™é¡¹ç›®ç‚¹ä¸ª Star
- ğŸ’¬ è¯„è®ºåŒºèŠèŠä½ è¸©è¿‡çš„å‘
- ğŸ“¤ åˆ†äº«ç»™æ­£åœ¨å­¦ K8s çš„æœ‹å‹

**ä½ é‡åˆ°è¿‡ CrashLoopBackOff å—ï¼Ÿæ€ä¹ˆæ’æŸ¥çš„ï¼Ÿæ¬¢è¿è¯„è®ºï¼**

---

**ä½œè€…**ï¼šä¸€ä¸ªè¢«å¥åº·æ£€æŸ¥å‘è¿‡çš„å­¦ä¹ è€…  
**æ—¥æœŸ**ï¼š2025-10-27  
**ç³»åˆ—**ï¼šCloudNative Go Journey v0.1

ä¸Šä¸€ç¯‡ï¼š[ã€Šä»é›¶å¼€å§‹çš„äº‘åŸç”Ÿä¹‹æ—…ï¼ˆäºŒï¼‰ï¼šç¬¬ä¸€æ¬¡éƒ¨ç½²åˆ° K8sã€‹](02-kubernetes-deployment.md)  
ä¸‹ä¸€ç¯‡ï¼šv0.2 ç¼–æ’å‡çº§ç‰ˆï¼ˆè§„åˆ’ä¸­ï¼‰
